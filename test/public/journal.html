<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📊 JOURNAL - TradePlus V5</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  
  <!-- Ag-Grid Community -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-grid.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-theme-alpine-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/dist/ag-grid-community.min.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    * {
      --color-emerald: #10b981;
      --color-red: #ef4444;
      --color-slate-900: #0f172a;
      --color-slate-800: #1e293b;
      --color-slate-700: #334155;
      --color-text-primary: #e2e8f0;
      --color-text-secondary: #94a3b8;
    }
    
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--color-text-primary);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .kpi-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(71, 85, 105, 0.5);
      transform: translateY(-2px);
    }
    
    .chart-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }
    
    .gain {
      color: var(--color-emerald);
      font-weight: 600;
    }
    
    .loss {
      color: var(--color-red);
      font-weight: 600;
    }
    
    .tab-btn {
      border-bottom: 3px solid transparent;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--color-text-secondary);
    }
    
    .tab-btn.active {
      border-bottom-color: var(--color-emerald);
      color: var(--color-emerald);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    
    .date-filter-btn {
      background: rgba(51, 65, 85, 0.5);
      color: #94a3b8;
      border: 1px solid rgba(71, 85, 105, 0.3);
    }
    
    .date-filter-btn:hover {
      background: rgba(71, 85, 105, 0.8);
      color: #e2e8f0;
    }
    
    .date-filter-btn.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(16, 185, 129, 0.3);
      border-top: 3px solid var(--color-emerald);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .table-row {
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      transition: background 0.2s ease;
    }
    
    .table-row:hover {
      background: rgba(16, 185, 129, 0.05);
    }
    
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    
    /* Modal Ag-Grid Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 12px;
      width: 95%;
      max-width: 1400px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #475569;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-body {
      flex: 1;
      overflow: hidden;
      padding: 20px;
    }
    
    .ag-theme-alpine-dark {
      --ag-background-color: #1e293b;
      --ag-header-background-color: #334155;
      --ag-odd-row-background-color: #1e293b;
      --ag-row-hover-color: rgba(16, 185, 129, 0.1);
      --ag-border-color: #475569;
      --ag-header-foreground-color: #94a3b8;
      --ag-foreground-color: #e2e8f0;
    }
    
    .modal-close-btn {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .modal-close-btn:hover {
      background: #334155;
      color: #e2e8f0;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="sticky top-0 z-50 backdrop-blur-lg bg-slate-900/80 border-b border-slate-700/50">
  <div class="max-w-7xl mx-auto px-6 py-4">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h1 class="text-3xl font-bold">📊 JOURNAL</h1>
        <p class="text-slate-400 text-sm">Análisis de trading en tiempo real</p>
      </div>
      <div class="flex gap-4 items-center">
        <button onclick="refreshData()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-semibold transition">
          🔄 Actualizar
        </button>
        <span class="text-slate-400 text-sm">
          Última actualización: <span id="last-update" class="text-emerald-400">cargando...</span>
        </span>
      </div>
    </div>
    
    <!-- FILTRO DE FECHAS (SIEMPRE VISIBLE) -->
    <div class="flex items-center gap-4 bg-slate-800/50 rounded-lg p-3">
      <span class="text-slate-400 font-semibold text-sm">📅 PERÍODO:</span>
      <div class="flex gap-2">
        <button onclick="changeDays(7)" id="btn-7d" class="date-filter-btn px-4 py-2 rounded-lg font-semibold transition">
          7 días
        </button>
        <button onclick="changeDays(30)" id="btn-30d" class="date-filter-btn active px-4 py-2 rounded-lg font-semibold transition">
          30 días
        </button>
        <button onclick="changeDays(90)" id="btn-90d" class="date-filter-btn px-4 py-2 rounded-lg font-semibold transition">
          90 días
        </button>
        <button onclick="changeDays(365)" id="btn-365d" class="date-filter-btn px-4 py-2 rounded-lg font-semibold transition">
          1 año
        </button>
        <button onclick="showCustomDatePicker()" id="btn-custom" class="date-filter-btn px-4 py-2 rounded-lg font-semibold transition">
          📆 Custom
        </button>
      </div>
      <div class="ml-auto flex flex-col items-end">
        <span id="current-period-display" class="text-emerald-400 font-bold">
          Últimos 30 días
        </span>
        <span id="current-period-stats" class="text-slate-400 text-xs mt-1">
          Cargando...
        </span>
      </div>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="max-w-7xl mx-auto px-6 py-8">

  <!-- TABS -->
  <div class="flex gap-0 mb-8 border-b border-slate-700">
    <button id="tab-btn-schwab" onclick="switchTab('schwab')" class="tab-btn active">
      📈 SCHWAB (<span id="count-schwab">-</span> ops)
    </button>
    <button id="tab-btn-coinbase" onclick="switchTab('coinbase')" class="tab-btn">
      🪙 COINBASE (<span id="count-coinbase">-</span> ops)
    </button>
    <button id="tab-btn-all" onclick="switchTab('all')" class="tab-btn">
      🌐 TODOS (<span id="count-all">-</span> ops)
    </button>
  </div>

  <!-- TAB SCHWAB -->
  <div id="tab-schwab" class="tab-content active">
    
    <!-- KPIs Row 1 - Métricas principales de P&L -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all" onclick="showAllOperations('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Total Ops</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-ops">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-pl-realized" style="color: var(--color-emerald);">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-schwab-pl-realized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-pl-unrealized">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-schwab-pl-unrealized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-purple-500 transition-all" onclick="showPositionsSummary('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Posiciones</p>
        <p class="text-2xl font-bold mt-2">
          <span class="gain" id="kpi-schwab-pos-closed">-</span> / 
          <span class="text-slate-400" id="kpi-schwab-pos-open">-</span>
        </p>
        <p class="text-xs text-slate-400 mt-1">Cerr / Abier</p>
      </div>
    </div>
    
    <!-- KPIs Row 2 - Métricas de rendimiento -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado %</p>
        <p class="text-3xl font-bold mt-2 gain" id="kpi-schwab-pl-realized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Cerradas)</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized %</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-pl-unrealized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Abiertas)</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Win Rate</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-wr">-</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Profit Factor</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-pf">-</p>
      </div>
    </div>
    
    <!-- Posiciones Abiertas -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">📊 Posiciones Abiertas</h3>
      <div id="open-positions-schwab" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <!-- Capital + Charts -->
    <!-- Capital KPIs + Configuración (full width horizontal) -->
    <div class="chart-card mb-6">
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
        
        <!-- Capital Actual -->
        <div class="bg-slate-800/30 rounded p-4">
          <p class="text-xs text-slate-400 mb-1">💰 Capital Actual</p>
          <p class="text-2xl font-bold gain" id="capital-actual-schwab">$-</p>
        </div>
        
        <!-- P/L Day USD -->
        <div class="bg-slate-800/30 rounded p-4">
          <p class="text-xs text-slate-400 mb-1">📊 P/L Day</p>
          <p class="text-2xl font-bold" id="pl-day-usd-schwab">$-</p>
        </div>
        
        <!-- P/L Day % -->
        <div class="bg-slate-800/30 rounded p-4">
          <p class="text-xs text-slate-400 mb-1">📈 P/L Day %</p>
          <p class="text-2xl font-bold" id="pl-day-pct-schwab">-%</p>
        </div>
        
        <!-- Progreso -->
        <div class="bg-slate-800/30 rounded p-4">
          <p class="text-xs text-slate-400 mb-1">🎯 Progreso</p>
          <p class="text-2xl font-bold gain" id="progress-pct-schwab">0%</p>
          <p class="text-xs text-slate-400 mt-1" id="progress-text-short-schwab">-</p>
        </div>
        
        <!-- Días restantes -->
        <div class="bg-slate-800/30 rounded p-4">
          <p class="text-xs text-slate-400 mb-1">⏱️ Días restantes</p>
          <p class="text-2xl font-bold text-blue-400" id="days-remaining-schwab">-</p>
          <p class="text-xs text-slate-400 mt-1" id="days-elapsed-schwab">-</p>
        </div>
      </div>
      
      <!-- Configuración de fechas y meta -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mt-4 p-4 bg-slate-800/20 rounded">
        <div>
          <label class="text-xs text-slate-400 block mb-1">Fecha Inicial</label>
          <div class="flex gap-2">
            <input type="date" id="fecha-inicial-schwab" value="2025-10-28"
                   class="bg-slate-700 text-white px-3 py-2 rounded text-sm flex-1"
                   onchange="updateCapitalGoal('schwab')">
            <button onclick="restoreInitialDate('schwab')" 
                    class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs transition"
                    title="Restaurar a primer trade">
              🔄
            </button>
          </div>
        </div>
        
        <div>
          <label class="text-xs text-slate-400 block mb-1">Fecha Meta</label>
          <input type="date" id="meta-fecha-schwab" value="2026-12-31"
                 class="bg-slate-700 text-white px-3 py-2 rounded text-sm w-full"
                 onchange="updateCapitalGoal('schwab')">
        </div>
        
        <div>
          <label class="text-xs text-slate-400 block mb-1">Capital Meta</label>
          <div class="flex items-center gap-2 bg-slate-700 rounded px-3 py-2">
            <span class="text-slate-400 text-sm">$</span>
            <input type="text" id="meta-capital-schwab" value="25,000" 
                   class="bg-transparent text-white text-sm flex-1 text-right outline-none"
                   onchange="updateCapitalGoal('schwab')"
                   onblur="formatMetaInput('schwab')"
                   onfocus="unformatMetaInput('schwab')">
          </div>
        </div>
        
        <div class="flex items-end">
          <div class="w-full bg-emerald-900/20 rounded p-3">
            <p class="text-xs text-slate-400 mb-1">Falta para meta</p>
            <p class="text-lg font-bold gain" id="progress-text-schwab">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Capital Evolution Chart (full width) -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">📈 Evolución de Capital hacia la Meta</h3>
      <canvas id="chart-capital-schwab" height="120"></canvas>
    </div>

    <!-- AG Grid: Análisis Detallado por Símbolo -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">🎯 Análisis Detallado por Símbolo (usa filtros para ver operaciones específicas)</h3>
      <div id="grid-top-symbols-schwab" class="ag-theme-alpine-dark" style="height: 500px; width: 100%;"></div>
    </div>

    <!-- Trades Table -->
    <div class="chart-card mb-8" id="trades-section-schwab">
      <h3 class="text-lg font-bold mb-4">📋 Detalle de Trades</h3>
      <div id="grid-schwab" class="ag-theme-alpine-dark" style="height: 600px; width: 100%;"></div>
    </div>

    <!-- Top Winners/Losers -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">🥇 Top 5 Ganadores</h3>
        <div id="winners-list-schwab" class="space-y-3"></div>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">🔻 Top 5 Perdedores</h3>
        <div id="losers-list-schwab" class="space-y-3"></div>
      </div>
    </div>

  </div>

  <!-- TAB COINBASE -->
  <div id="tab-coinbase" class="tab-content">
    
    <!-- KPIs Row 1 - Métricas principales de P&L -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all" onclick="showAllOperations('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Total Ops</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-ops">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-pl-realized" style="color: var(--color-emerald);">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-coinbase-pl-realized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-pl-unrealized">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-coinbase-pl-unrealized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-purple-500 transition-all" onclick="showPositionsSummary('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Posiciones</p>
        <p class="text-2xl font-bold mt-2">
          <span class="gain" id="kpi-coinbase-pos-closed">-</span> / 
          <span class="text-slate-400" id="kpi-coinbase-pos-open">-</span>
        </p>
        <p class="text-xs text-slate-400 mt-1">Cerr / Abier</p>
      </div>
    </div>
    
    <!-- KPIs Row 2 - Métricas de rendimiento -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado %</p>
        <p class="text-3xl font-bold mt-2 gain" id="kpi-coinbase-pl-realized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Cerradas)</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized %</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-pl-unrealized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Abiertas)</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Win Rate</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-wr">-</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Profit Factor</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-pf">-</p>
      </div>
    </div>
    
    <!-- Posiciones Abiertas -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">📊 Posiciones Abiertas</h3>
      <div id="open-positions-coinbase" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <!-- Performance por Hora -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">⏰ Performance por Hora del Día</h3>
      <canvas id="chart-hourly-coinbase" height="200"></canvas>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">💰 Capital & P/L Day</h3>
        
        <!-- Capital Actual -->
        <div class="mb-4">
          <p class="text-sm text-slate-400">Capital Actual</p>
          <p class="text-3xl font-bold gain mb-2" id="capital-actual-coinbase">$-</p>
        </div>
        
        <!-- P/L Day (from Coinbase API) -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-slate-800/50 rounded p-3">
            <p class="text-xs text-slate-400 mb-1">P/L Day</p>
            <p class="text-xl font-bold" id="pl-day-usd-coinbase">$-</p>
          </div>
          <div class="bg-slate-800/50 rounded p-3">
            <p class="text-xs text-slate-400 mb-1">P/L Day %</p>
            <p class="text-xl font-bold" id="pl-day-pct-coinbase">-%</p>
          </div>
        </div>
        
        <!-- Meta editable -->
        <div class="bg-slate-800/50 rounded p-3 mb-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-xs text-slate-400">Meta:</span>
            <div class="flex items-center gap-2">
              <span class="text-xs text-slate-400">$</span>
              <input type="number" id="meta-capital-coinbase" value="25000" 
                     class="bg-slate-700 text-white px-2 py-1 rounded w-24 text-sm text-right"
                     onchange="updateCapitalGoal('coinbase')">
            </div>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-xs text-slate-400">Fecha:</span>
            <input type="date" id="meta-fecha-coinbase" value="2026-12-31"
                   class="bg-slate-700 text-white px-2 py-1 rounded text-sm"
                   onchange="updateCapitalGoal('coinbase')">
          </div>
        </div>
        
        <!-- Progreso -->
        <div class="bg-emerald-900/20 rounded p-4">
          <div class="flex justify-between mb-2">
            <span class="text-sm text-slate-400">Progreso</span>
            <span class="text-sm font-bold gain" id="progress-pct-coinbase">0%</span>
          </div>
          <div class="w-full bg-slate-700 rounded h-3 overflow-hidden">
            <div class="bg-emerald-500 h-3 rounded transition-all duration-500" id="progress-bar-coinbase" style="width: 0%"></div>
          </div>
          <p class="text-xs text-slate-400 mt-2 text-center" id="progress-text-coinbase">-</p>
        </div>
      </div>
      <div class="chart-card lg:col-span-2">
        <h3 class="text-lg font-bold mb-4">📈 Evolución de Capital</h3>
        <canvas id="chart-capital-coinbase" height="200"></canvas>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">📊 P&L Acumulado (Diario)</h3>
        <canvas id="chart-pl-daily-coinbase" height="250"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">🎯 Top Símbolos</h3>
        <canvas id="chart-symbols-coinbase" height="250"></canvas>
      </div>
    </div>

    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">📋 Detalle de Trades</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="border-b border-slate-600">
            <tr class="text-slate-400 text-xs uppercase">
              <th class="text-left py-3 px-4">Fecha</th>
              <th class="text-left py-3 px-4">Símbolo</th>
              <th class="text-left py-3 px-4">Lado</th>
              <th class="text-right py-3 px-4">Cantidad</th>
              <th class="text-right py-3 px-4">Precio</th>
              <th class="text-right py-3 px-4">Total</th>
              <th class="text-right py-3 px-4">Fee</th>
              <th class="text-right py-3 px-4">P&L USD</th>
              <th class="text-right py-3 px-4">P&L %</th>
            </tr>
          </thead>
          <tbody id="tbody-coinbase"></tbody>
        </table>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">🥇 Top Ganadores</h3>
        <div id="winners-list-coinbase" class="space-y-3"></div>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">🔻 Top Perdedores</h3>
        <div id="losers-list-coinbase" class="space-y-3"></div>
      </div>
    </div>

  </div>

  <!-- TAB ALL (TODOS) -->
  <div id="tab-all" class="tab-content">
    
    <!-- KPIs Row 1 - Métricas principales de P&L -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all" onclick="showAllOperations('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Total Ops</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-ops">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-pl-realized" style="color: var(--color-emerald);">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-all-pl-realized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-pl-unrealized">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-all-pl-unrealized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-purple-500 transition-all" onclick="showPositionsSummary('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Posiciones</p>
        <p class="text-2xl font-bold mt-2">
          <span class="gain" id="kpi-all-pos-closed">-</span> / 
          <span class="text-slate-400" id="kpi-all-pos-open">-</span>
        </p>
        <p class="text-xs text-slate-400 mt-1">Cerr / Abier</p>
      </div>
    </div>
    
    <!-- KPIs Row 2 - Métricas de rendimiento -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado %</p>
        <p class="text-3xl font-bold mt-2 gain" id="kpi-all-pl-realized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Cerradas)</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized %</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-pl-unrealized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Abiertas)</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Win Rate</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-wr">-</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Profit Factor</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-pf">-</p>
      </div>
    </div>
    
    <!-- Posiciones Abiertas -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">📊 Posiciones Abiertas (Combinado)</h3>
      <div id="open-positions-all" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <!-- Performance por Hora -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">⏰ Performance por Hora del Día (Todos los Brokers)</h3>
      <canvas id="chart-hourly-all" height="200"></canvas>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">💰 Capital & P/L Day</h3>
        
        <!-- Capital Actual -->
        <div class="mb-4">
          <p class="text-sm text-slate-400">Capital Actual</p>
          <p class="text-3xl font-bold gain mb-2" id="capital-actual-all">$-</p>
        </div>
        
        <!-- P/L Day (combinado) -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-slate-800/50 rounded p-3">
            <p class="text-xs text-slate-400 mb-1">P/L Day</p>
            <p class="text-xl font-bold" id="pl-day-usd-all">$-</p>
          </div>
          <div class="bg-slate-800/50 rounded p-3">
            <p class="text-xs text-slate-400 mb-1">P/L Day %</p>
            <p class="text-xl font-bold" id="pl-day-pct-all">-%</p>
          </div>
        </div>
        
        <!-- Meta editable -->
        <div class="bg-slate-800/50 rounded p-3 mb-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-xs text-slate-400">Meta:</span>
            <div class="flex items-center gap-2">
              <span class="text-xs text-slate-400">$</span>
              <input type="number" id="meta-capital-all" value="25000" 
                     class="bg-slate-700 text-white px-2 py-1 rounded w-24 text-sm text-right"
                     onchange="updateCapitalGoal('all')">
            </div>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-xs text-slate-400">Fecha:</span>
            <input type="date" id="meta-fecha-all" value="2026-12-31"
                   class="bg-slate-700 text-white px-2 py-1 rounded text-sm"
                   onchange="updateCapitalGoal('all')">
          </div>
        </div>
        
        <!-- Progreso -->
        <div class="bg-emerald-900/20 rounded p-4">
          <div class="flex justify-between mb-2">
            <span class="text-sm text-slate-400">Progreso</span>
            <span class="text-sm font-bold gain" id="progress-pct-all">0%</span>
          </div>
          <div class="w-full bg-slate-700 rounded h-3 overflow-hidden">
            <div class="bg-emerald-500 h-3 rounded transition-all duration-500" id="progress-bar-all" style="width: 0%"></div>
          </div>
          <p class="text-xs text-slate-400 mt-2 text-center" id="progress-text-all">-</p>
        </div>
      </div>
      <div class="chart-card lg:col-span-2">
        <h3 class="text-lg font-bold mb-4">📈 Evolución de Capital (Combinado)</h3>
        <canvas id="chart-capital-all" height="200"></canvas>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">📊 P&L Acumulado (Diario)</h3>
        <canvas id="chart-pl-daily-all" height="250"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">🎯 Top Símbolos</h3>
        <canvas id="chart-symbols-all" height="250"></canvas>
      </div>
    </div>

    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">📋 Detalle de Trades (últimos 50)</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="border-b border-slate-600">
            <tr class="text-slate-400 text-xs uppercase">
              <th class="text-left py-3 px-4">Broker</th>
              <th class="text-left py-3 px-4">Fecha</th>
              <th class="text-left py-3 px-4">Símbolo</th>
              <th class="text-left py-3 px-4">Lado</th>
              <th class="text-right py-3 px-4">Cantidad</th>
              <th class="text-right py-3 px-4">Precio</th>
              <th class="text-right py-3 px-4">Total</th>
              <th class="text-right py-3 px-4">Fee</th>
              <th class="text-right py-3 px-4">P&L USD</th>
              <th class="text-right py-3 px-4">P&L %</th>
            </tr>
          </thead>
          <tbody id="tbody-all"></tbody>
        </table>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">🥇 Top 10 Ganadores</h3>
        <div id="winners-list-all" class="space-y-3"></div>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">🔻 Top 10 Perdedores</h3>
        <div id="losers-list-all" class="space-y-3"></div>
      </div>
    </div>

  </div>

</main>

<!-- SCRIPTS -->
<script>
  let chartsMap = {};  // Guardar refs de charts para actualizar
  let gridsMap = {};   // Guardar refs de AG Grid para actualizar
  let schwabData = null;
  let coinbaseData = null;
  let allData = null;
  let currentDays = 30;  // Default 30 días
  let ws = null;  // WebSocket connection
  let currentBroker = 'schwab';  // Broker activo

  // ========================================================================
  // FORMATEO CENTRALIZADO DE NÚMEROS
  // ========================================================================
  
  /**
   * Formatea un número con separador de miles (coma) y decimales (punto)
   * @param {number} value - Valor a formatear
   * @param {number} decimals - Número de decimales (default: 2)
   * @param {boolean} includeSign - Si incluir signo + para positivos
   * @returns {string} - Número formateado: "1,234.56" o "+1,234.56"
   */
  function formatNumber(value, decimals = 2, includeSign = false) {
    const sign = includeSign && value >= 0 ? '+' : '';
    return sign + value.toLocaleString('en-US', {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });
  }

  /**
   * Formatea un monto en USD con símbolo $
   * @param {number} value - Valor a formatear
   * @param {number} decimals - Número de decimales (default: 2)
   * @param {boolean} includeSign - Si incluir signo + para positivos
   * @returns {string} - "$1,234.56" o "+$1,234.56"
   */
  function formatUSD(value, decimals = 2, includeSign = false) {
    const sign = includeSign && value >= 0 ? '+' : '';
    const absValue = Math.abs(value);
    return sign + '$' + absValue.toLocaleString('en-US', {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });
  }

  /**
   * Formatea un porcentaje con símbolo %
   * @param {number} value - Valor del porcentaje
   * @param {number} decimals - Número de decimales (default: 2)
   * @param {boolean} includeSign - Si incluir signo + para positivos
   * @returns {string} - "12.34%" o "+12.34%"
   */
  function formatPercent(value, decimals = 2, includeSign = true) {
    const sign = includeSign && value >= 0 ? '+' : '';
    return sign + value.toFixed(decimals) + '%';
  }

  /**
   * Determina el número de decimales correcto para un símbolo crypto
   * @param {string} symbol - Símbolo del producto (ej: "BTC-USD")
   * @returns {number} - Número de decimales (2-8)
   */
  function getDecimalsForSymbol(symbol) {
    // Stocks (Schwab): siempre 2 decimales
    if (!symbol.includes('-USD')) {
      return 2;
    }
    
    // Crypto (Coinbase): depende del token
    // Tokens principales: 2 decimales
    if (['BTC-USD', 'ETH-USD', 'SOL-USD', 'BNB-USD'].includes(symbol)) {
      return 2;
    }
    
    // Tokens de precio medio: 4 decimales
    if (['ADA-USD', 'DOT-USD', 'MATIC-USD'].includes(symbol)) {
      return 4;
    }
    
    // Tokens pequeños: 6-8 decimales
    if (['SHIB-USD', 'PEPE-USD', 'FLOKI-USD'].includes(symbol)) {
      return 8;
    }
    
    // Default: 4 decimales para crypto desconocido
    return 4;
  }

  // ========================================================================
  // WEBSOCKET CONNECTION
  // ========================================================================
  
  function connectWebSocket() {
    const wsUrl = `ws://${window.location.host}/ws/journal`;
    console.log('🔌 Conectando a WebSocket:', wsUrl);
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = () => {
      console.log('✅ WebSocket conectado');
      // Solicitar datos iniciales
      requestData();
    };
    
    ws.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data);
        console.log('📨 Mensaje recibido:', message.type);
        
        if (message.data) {
          // Actualizar datos según el broker
          const broker = message.broker || 'all';
          
          if (broker === 'all') {
            allData = message.data;
            if (currentBroker === 'all') renderTab('all');
          } else if (broker === 'schwab') {
            schwabData = message.data;
            if (currentBroker === 'schwab') renderTab('schwab');
          } else if (broker === 'coinbase') {
            coinbaseData = message.data;
            if (currentBroker === 'coinbase') renderTab('coinbase');
          }
          
          // Actualizar timestamp
          const now = new Date();
          document.getElementById('last-update').textContent = now.toLocaleTimeString('es-ES');
          
          // Actualizar contador
          updateStatsCounter();
        }
      } catch (error) {
        console.error('❌ Error procesando mensaje:', error);
      }
    };
    
    ws.onerror = (error) => {
      console.error('❌ WebSocket error:', error);
    };
    
    ws.onclose = () => {
      console.log('🔌 WebSocket desconectado, reconectando en 3s...');
      setTimeout(connectWebSocket, 3000);
    };
  }
  
  function requestData() {
    if (ws && ws.readyState === WebSocket.OPEN) {
      // Solicitar los 3 brokers con el período actual
      ws.send(JSON.stringify({ broker: 'all', days: currentDays }));
      ws.send(JSON.stringify({ broker: 'schwab', days: currentDays }));
      ws.send(JSON.stringify({ broker: 'coinbase', days: currentDays }));
    }
  }
  
  function updateStatsCounter() {
    // Solo mostrar datos del broker activo (schwab o coinbase), no ambos
    let statsText = 'Cargando...';
    
    if (currentBroker === 'schwab' && schwabData) {
      const ops = schwabData.stats?.total_ops || 0;
      const trades = schwabData.trades?.length || 0;
      statsText = `${ops} operaciones | ${trades} trades | Schwab`;
    } else if (currentBroker === 'coinbase' && coinbaseData) {
      const ops = coinbaseData.stats?.total_ops || 0;
      const trades = coinbaseData.trades?.length || 0;
      statsText = `${ops} operaciones | ${trades} trades | Coinbase`;
    } else if (currentBroker === 'all' && allData) {
      const ops = allData.stats?.total_ops || 0;
      const trades = allData.trades?.length || 0;
      statsText = `${ops} operaciones | ${trades} trades | Todos los brokers`;
    }
    
    document.getElementById('current-period-stats').textContent = statsText;
  }

  // ========================================================================
  // GESTIÓN DE FILTROS DE FECHA
  // ========================================================================
  
  function changeDays(days) {
    console.log('🔄 Cambiando período a:', days, 'días');
    currentDays = days;
    
    // Update active button
    document.querySelectorAll('.date-filter-btn').forEach(btn => btn.classList.remove('active'));
    const targetBtn = document.getElementById(`btn-${days}d`);
    if (targetBtn) {
      targetBtn.classList.add('active');
    } else {
      console.error('❌ No se encontró botón con ID:', `btn-${days}d`);
    }
    
    // Update display text
    const displayTexts = {
      7: 'Últimos 7 días',
      30: 'Últimos 30 días',
      90: 'Últimos 90 días',
      365: 'Último año'
    };
    const displayText = displayTexts[days] || `Últimos ${days} días`;
    document.getElementById('current-period-display').textContent = displayText;
    console.log('📅 Período actualizado a:', displayText);
    
    // Destruir TODOS los charts antes de recargar
    Object.keys(chartsMap).forEach(key => {
      if (chartsMap[key]) {
        chartsMap[key].destroy();
        console.log('🗑️ Chart destruido:', key);
      }
    });
    chartsMap = {};
    
    // Solicitar nuevos datos via WebSocket
    console.log('📊 Solicitando datos via WebSocket con days=', currentDays);
    requestData();
  }
  
  function showCustomDatePicker() {
    // TODO: Implementar modal con date pickers
    alert('📆 Custom date picker - Por implementar\n\nPor ahora usa los botones predefinidos: 7d, 30d, 90d, 1 año');
  }

  // ========================================================================
  // CARGAR DATOS (LEGACY - Ahora usamos WebSocket)
  // ========================================================================
  
  // Función eliminada - Todo se maneja via WebSocket ahora

  // ========================================================================
  // RENDERIZAR POSICIONES ABIERTAS
  // ========================================================================
  
  function renderOpenPositions(positions, broker) {
    const container = document.getElementById(`open-positions-${broker}`);
    if (!container) return;
    
    if (!positions || positions.length === 0) {
      container.innerHTML = '<div class="col-span-3 text-center text-slate-400 py-4">Sin posiciones abiertas</div>';
      return;
    }
    
    // El backend YA agrupa por símbolo, solo renderizar con formateo centralizado
    container.innerHTML = positions.map(pos => {
      const pl = pos.unrealized_pl || 0;
      const plPct = pos.unrealized_percent || 0;
      const plClass = pl >= 0 ? 'gain' : 'loss';
      // Determinar decimales: si es crypto (Coinbase), usar getDecimalsForSymbol, si no 2
      const decimals = pos.symbol.includes('-USD') ? getDecimalsForSymbol(pos.symbol) : 2;
      
      return `
        <div class="kpi-card">
          <div class="flex justify-between items-start mb-2">
            <span class="font-bold text-xl text-emerald-400">${pos.symbol}</span>
            <span class="text-xs px-2 py-1 rounded bg-blue-900/30 text-blue-400">
              LONG
            </span>
          </div>
          <div class="text-sm text-slate-400 space-y-1">
            <div class="flex justify-between">
              <span>Cantidad:</span>
              <span class="font-bold text-white">${pos.qty % 1 === 0 ? pos.qty.toFixed(0) : pos.qty.toFixed(decimals)} ${pos.symbol.includes('-USD') ? 'units' : 'shares'}</span>
            </div>
            <div class="flex justify-between">
              <span>Avg Cost:</span>
              <span class="font-bold text-white">${formatUSD(pos.avg_cost, decimals, false)}</span>
            </div>
            <div class="flex justify-between">
              <span>Current:</span>
              <span class="font-bold text-white">${formatUSD(pos.current_price, decimals, false)}</span>
            </div>
            <div class="flex justify-between">
              <span>Cost Basis:</span>
              <span class="font-bold text-white">${formatUSD(pos.cost_basis, 2, false)}</span>
            </div>
            <div class="flex justify-between pt-2 border-t border-slate-600">
              <span>P&L Unrealized:</span>
              <span class="font-bold ${plClass}">${formatUSD(pl, 2, true)} (${formatPercent(plPct, 2, true)})</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ========================================================================
  // RENDERIZAR TAB
  // ========================================================================

  function renderTab(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data || data.error) return;

    const suffix = broker === 'schwab' ? '-schwab' : (broker === 'coinbase' ? '-coinbase' : '-all');

    // KPIs - USAR CAMPOS CORRECTOS DEL API T0
    const stats = data.stats || {};
    const positions = data.positions || {};
    
    // Total Ops = operaciones (no trades individuales)
    document.getElementById(`kpi-${broker}-ops`).textContent = stats.total_ops || 0;
    
    // P&L Realizado vs Unrealized - USAR CAMPOS _usd Y % con formateo centralizado
    const plRealized = stats.pl_realized_usd || 0;
    const plRealizedPct = stats.pl_realized_percent || 0;
    const plUnrealized = stats.pl_unrealized_usd || 0;
    const plUnrealizedPct = stats.pl_unrealized_percent || 0;
    
    // Row 1: P&L USD con formateo (signo + comas separador de miles)
    document.getElementById(`kpi-${broker}-pl-realized`).textContent = formatUSD(plRealized, 2, true);
    document.getElementById(`kpi-${broker}-pl-realized`).className = `text-3xl font-bold mt-2 ${plRealized >= 0 ? 'gain' : 'loss'}`;
    
    // Actualizar el texto de porcentaje de P&L Realizado
    const plRealizedSubtext = document.querySelector(`#kpi-${broker}-pl-realized`).nextElementSibling;
    if (plRealizedSubtext) {
      plRealizedSubtext.textContent = `${formatPercent(plRealizedPct, 2, true)} (Cerradas)`;
    }
    
    document.getElementById(`kpi-${broker}-pl-unrealized`).textContent = formatUSD(plUnrealized, 2, true);
    document.getElementById(`kpi-${broker}-pl-unrealized`).className = `text-3xl font-bold mt-2 ${plUnrealized >= 0 ? 'gain' : (plUnrealized < 0 ? 'loss' : 'text-slate-400')}`;
    
    // Actualizar el texto de porcentaje de P&L Unrealized
    const plUnrealizedSubtext = document.querySelector(`#kpi-${broker}-pl-unrealized`).nextElementSibling;
    if (plUnrealizedSubtext) {
      plUnrealizedSubtext.textContent = `${formatPercent(plUnrealizedPct, 2, true)} (Abiertas)`;
    }
    
    // Actualizar subtextos de porcentaje en Row 1 (debajo de P&L USD)
    const plRealizedPctSub = document.getElementById(`kpi-${broker}-pl-realized-pct-sub`);
    if (plRealizedPctSub) {
      plRealizedPctSub.textContent = `${formatPercent(plRealizedPct, 2, true)} (Cerradas)`;
      plRealizedPctSub.className = `text-xs mt-1 ${plRealizedPct >= 0 ? 'gain' : 'loss'}`;
    }
    
    const plUnrealizedPctSub = document.getElementById(`kpi-${broker}-pl-unrealized-pct-sub`);
    if (plUnrealizedPctSub) {
      plUnrealizedPctSub.textContent = `${formatPercent(plUnrealizedPct, 2, true)} (Abiertas)`;
      plUnrealizedPctSub.className = `text-xs mt-1 ${plUnrealizedPct >= 0 ? 'gain' : 'loss'}`;
    }
    
    // NUEVOS KPIs Row 2: P&L % como tarjetas principales
    const plRealizedPctElement = document.getElementById(`kpi-${broker}-pl-realized-pct`);
    if (plRealizedPctElement) {
      plRealizedPctElement.textContent = formatPercent(plRealizedPct, 2, true);
      plRealizedPctElement.className = `text-3xl font-bold mt-2 ${plRealizedPct >= 0 ? 'gain' : 'loss'}`;
    }
    
    const plUnrealizedPctElement = document.getElementById(`kpi-${broker}-pl-unrealized-pct`);
    if (plUnrealizedPctElement) {
      plUnrealizedPctElement.textContent = formatPercent(plUnrealizedPct, 2, true);
      plUnrealizedPctElement.className = `text-3xl font-bold mt-2 ${plUnrealizedPct >= 0 ? 'gain' : (plUnrealizedPct < 0 ? 'loss' : 'text-slate-400')}`;
    }
    
    document.getElementById(`kpi-${broker}-wr`).textContent = formatPercent(stats.win_rate || 0, 2, false);
    document.getElementById(`kpi-${broker}-pf`).textContent = formatNumber(stats.profit_factor || 0, 2, false);
    
    // Posiciones abiertas/cerradas - USAR positions del API
    const posClosed = positions.closed_count || 0;
    const posOpen = positions.open_count || 0;
    document.getElementById(`kpi-${broker}-pos-closed`).textContent = posClosed;
    document.getElementById(`kpi-${broker}-pos-open`).textContent = posOpen;
    
    // Count total de trades (no ops)
    const tradesCount = data.period?.trades_count || data.trades?.length || 0;
    document.getElementById(`count-${broker}`).textContent = tradesCount;
    
    // Renderizar posiciones abiertas - USAR open_detail
    renderOpenPositions(data.positions?.open_detail || [], broker);

    // Capital - usar formateo centralizado
    const capital = data.capital || {};
    const currentCapital = capital.current || 5000;
    document.getElementById(`capital-actual-${broker}`).textContent = formatUSD(currentCapital, 2, false);
    
    // P/L Day - calcular solo trades de HOY (fecha actual)
    const today = new Date().toISOString().split('T')[0]; // "2025-11-08"
    const todayTrades = (data.trades || []).filter(t => {
      const tradeDate = t.datetime.split('T')[0];
      return tradeDate === today && t.is_closed === true;
    });
    
    // Sumar P&L de trades cerrados hoy
    let plDayUsd = 0;
    let plDayCostBasis = 0;
    todayTrades.forEach(t => {
      plDayUsd += (t.pl_usd || 0);
      plDayCostBasis += (t.cost_basis || 0);
    });
    
    const plDayPct = plDayCostBasis > 0 ? (plDayUsd / plDayCostBasis * 100) : 0;
    
    const plDayElement = document.getElementById(`pl-day-usd-${broker}`);
    if (plDayElement) {
      if (todayTrades.length === 0) {
        // No hay trades cerrados hoy
        plDayElement.textContent = '$0.00';
        plDayElement.className = 'text-xl font-bold text-slate-400';
      } else {
        plDayElement.textContent = formatUSD(plDayUsd, 2, true);
        plDayElement.className = `text-xl font-bold ${plDayUsd >= 0 ? 'gain' : 'loss'}`;
      }
    }
    
    const plDayPctElement = document.getElementById(`pl-day-pct-${broker}`);
    if (plDayPctElement) {
      if (todayTrades.length === 0) {
        plDayPctElement.textContent = '0.00%';
        plDayPctElement.className = 'text-xl font-bold text-slate-400';
      } else {
        plDayPctElement.textContent = formatPercent(plDayPct, 2, true);
        plDayPctElement.className = `text-xl font-bold ${plDayPct >= 0 ? 'gain' : 'loss'}`;
      }
    }
    
    // Progreso hacia meta - Ya no se calcula aquí, lo hace updateCapitalGoal()
    // Solo se mantiene por compatibilidad con el texto de progreso del diseño antiguo (coinbase/all)
    const metaInput = document.getElementById(`meta-capital-${broker}`);
    if (metaInput) {
      const metaCapital = parseFloat(metaInput.value.replace(/,/g, '')) || 25000;
      const remaining = metaCapital - currentCapital;
      const progressText = remaining > 0 
        ? `Faltan ${formatUSD(remaining, 2, false)} para la meta`
        : `¡Meta alcanzada! +${formatUSD(Math.abs(remaining), 2, false)}`;
      
      const progressTextElement = document.getElementById(`progress-text-${broker}`);
      if (progressTextElement) {
        progressTextElement.textContent = progressText;
      }
    }

    // Actualizar cálculo de días restantes y gráfico de capital (esto llama a renderCapitalChart internamente)
    updateCapitalGoal(broker);

    // Renderizar AG Grid de análisis con Master/Detail
    renderTopSymbolsGrid(data, broker, suffix);
    renderHourlyPerformance(data.trades || [], broker, suffix);

    // Tabla
    const maxTrades = broker === 'all' ? 50 : 30;
    renderTable(data.trades || [], broker, suffix, maxTrades);

    // Winners/Losers
    const topN = broker === 'all' ? 10 : 5;
    renderWinnersLosers(data.trades || [], broker, suffix, topN);
  }

  // ========================================================================
  // CHARTS
  // ========================================================================

  function renderCapitalChart(data, broker, suffix) {
    const ctx = document.getElementById(`chart-capital${suffix}`);
    if (!ctx) {
      console.warn(`⚠️ No se encontró canvas para gráfico: chart-capital${suffix}`);
      return;
    }
    
    // Get date range from inputs
    const fechaInicialInput = document.getElementById(`fecha-inicial-${broker}`);
    const metaFechaInput = document.getElementById(`meta-fecha-${broker}`);
    const metaCapitalInput = document.getElementById(`meta-capital-${broker}`);
    
    const metaCapital = metaCapitalInput ? parseFloat(metaCapitalInput.value.replace(/,/g, '')) : 25000;
    
    // Usar el período seleccionado (currentDays: 7, 30, 90, 180, 365, all)
    const nowDate = new Date();
    const startDate = new Date(nowDate);
    
    // Calcular fecha inicial según período seleccionado
    if (currentDays === 'all') {
      // Si es "all", usar desde el primer trade
      if (data.trades && data.trades.length > 0) {
        const firstTrade = data.trades.reduce((oldest, trade) => {
          return trade.datetime < oldest.datetime ? trade : oldest;
        });
        startDate.setTime(new Date(firstTrade.datetime.split('T')[0]).getTime());
      } else {
        startDate.setDate(nowDate.getDate() - 30); // Default 30 días si no hay trades
      }
    } else {
      startDate.setDate(nowDate.getDate() - currentDays);
    }
    
    const endDate = nowDate;
    
    console.log(`📊 Renderizando gráfico ${broker} - Período: ${currentDays} días (${startDate.toISOString().split('T')[0]} → ${endDate.toISOString().split('T')[0]}), Meta: $${metaCapital.toLocaleString()}`);
    
    // Generate daily labels for selected period
    // Usar fecha local sin conversión UTC para evitar desfases de zona horaria
    const dailyLabels = [];
    const currentDate = new Date(startDate);
    while (currentDate <= endDate) {
      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const day = String(currentDate.getDate()).padStart(2, '0');
      dailyLabels.push(`${year}-${month}-${day}`);
      currentDate.setDate(currentDate.getDate() + 1);
    }
    
    console.log(`📅 dailyLabels generados (${dailyLabels.length} días):`, dailyLabels.slice(0, 10), '...');
    
    // Map evolution data to daily values
    const evolutionMap = {};
    const evolutionData = data.capital?.evolution || [];
    console.log(`   📈 Datos de evolución del backend: ${evolutionData.length} días`);
    
    evolutionData.forEach(d => {
      evolutionMap[d.date] = d.capital_end;
    });
    
    // Si no hay datos de evolución, generarlos desde los trades
    if (evolutionData.length === 0 && data.trades && data.trades.length > 0) {
      console.log(`   🔧 Generando evolución sintética desde ${data.trades.length} trades`);
      
      const initialCapital = data.capital?.initial || 5000;
      let runningCapital = initialCapital;
      
      // Agrupar trades por fecha y calcular P/L diario
      const tradesByDate = {};
      data.trades.forEach(trade => {
        if (!trade.datetime || !trade.is_closed) return;
        const tradeDate = trade.datetime.split('T')[0];
        if (!tradesByDate[tradeDate]) {
          tradesByDate[tradeDate] = 0;
        }
        tradesByDate[tradeDate] += (trade.pl_usd || 0);
      });
      
      // Crear evolución acumulada
      dailyLabels.forEach(date => {
        if (tradesByDate[date]) {
          runningCapital += tradesByDate[date];
        }
        evolutionMap[date] = runningCapital;
      });
      
      console.log(`   ✅ Evolución sintética generada: ${Object.keys(evolutionMap).length} días con datos`);
    }
    
    // Create daily data points, interpolating missing days
    const dailyData = [];
    let lastKnownValue = data.capital?.initial || 5000;
    
    console.log(`   💰 Capital inicial: $${lastKnownValue.toLocaleString()}, Capital actual: $${(data.capital?.current || 0).toLocaleString()}`);
    
    dailyLabels.forEach(date => {
      if (evolutionMap[date]) {
        lastKnownValue = evolutionMap[date];
        dailyData.push(lastKnownValue);
      } else {
        dailyData.push(lastKnownValue); // Repeat last known value
      }
    });
    
    console.log(`   📊 Datos para gráfico generados: ${dailyData.length} puntos`);
    
    if (dailyData.length === 0) {
      console.error(`   ❌ ERROR: No hay datos para graficar. dailyLabels: ${dailyLabels.length}, evolutionMap: ${Object.keys(evolutionMap).length}`);
      return;
    }
    
    console.log(`   📊 Rango de capital: $${Math.min(...dailyData).toFixed(2)} - $${Math.max(...dailyData).toFixed(2)}`);
    console.log(`   📊 Primer valor: $${dailyData[0]}, Último valor: $${dailyData[dailyData.length-1]}`);
    
    // Create projection line from current capital to meta
    const currentCapital = data.capital?.current || lastKnownValue;
    const today = new Date().toISOString().split('T')[0];
    const todayIndex = dailyLabels.indexOf(today);
    
    console.log(`   📅 Hoy: ${today}, Índice: ${todayIndex} de ${dailyLabels.length}`);
    
    const projectionData = dailyLabels.map((date, idx) => {
      if (idx < todayIndex) return null; // No projection before today
      if (idx === todayIndex) return currentCapital; // Start from current capital
      
      // Linear interpolation to meta at end date
      const daysFromToday = idx - todayIndex;
      const totalDaysToMeta = dailyLabels.length - todayIndex - 1;
      const progressPerDay = (metaCapital - currentCapital) / totalDaysToMeta;
      return currentCapital + (progressPerDay * daysFromToday);
    });
    
    const chartKey = `capital-${broker}`;
    if (chartsMap[chartKey]) {
      console.log(`   🗑️ Destruyendo gráfico anterior: ${chartKey}`);
      chartsMap[chartKey].destroy();
    }

    console.log(`   ✨ Creando gráfico ${chartKey} con ${dailyData.length} datos`);
    
    // Determinar si mostrar línea de meta (solo si el rango de datos es >$500 o estamos cerca de la meta)
    const maxData = Math.max(...dailyData);
    const minData = Math.min(...dailyData);
    const dataRange = maxData - minData;
    const showMetaLine = dataRange >= 500 || (maxData / metaCapital > 0.5);
    
    const datasets = [
      {
        label: 'Capital Diario (USD)',
        data: dailyData,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        pointRadius: 4, // Puntos visibles para cada día
        pointHoverRadius: 8, // Más grande al pasar mouse
        pointBackgroundColor: '#10b981',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointHoverBackgroundColor: '#10b981',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 3
      }
    ];
    
    // Agregar línea de meta solo si es relevante
    if (showMetaLine) {
      const metaLine = dailyLabels.map(() => metaCapital);
      datasets.push({
        label: `Meta: $${metaCapital.toLocaleString()}`,
        data: metaLine,
        borderColor: '#f59e0b',
        backgroundColor: 'transparent',
        borderWidth: 2,
        borderDash: [10, 5],
        fill: false,
        tension: 0,
        pointRadius: 0
      });
      console.log(`   🎯 Línea de meta incluida en gráfico`);
    } else {
      console.log(`   ℹ️ Línea de meta omitida (rango pequeño: $${dataRange.toFixed(2)})`);
    }
    
    chartsMap[chartKey] = new Chart(ctx.getContext('2d'), {
      type: 'line',
      data: {
        labels: dailyLabels.map(d => d.slice(5)), // MM-DD format
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const dataIndex = elements[0].index;
            const clickedDate = dailyLabels[dataIndex];
            console.log(`📅 Click en gráfico - DataIndex: ${dataIndex}, Total labels: ${dailyLabels.length}`);
            console.log(`📅 dailyLabels alrededor del click:`, dailyLabels.slice(Math.max(0, dataIndex-2), dataIndex+3));
            console.log(`📅 Fecha clickeada: ${clickedDate}, Broker: ${broker}`);
            
            // Scroll a la sección de trades
            const tradesSection = document.getElementById(`trades-section-${broker}`);
            console.log(`📊 Sección de trades encontrada:`, tradesSection ? 'Sí' : 'No');
            
            if (tradesSection) {
              tradesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              
              // Highlight trades de ese día usando AG Grid API
              setTimeout(() => {
                const gridKey = `grid-${broker}`;
                const grid = gridsMap[gridKey];
                
                if (!grid) {
                  console.warn(`⚠️ No se encontró AG Grid: ${gridKey}`);
                  return;
                }
                
                console.log(`🔍 Buscando trades del ${clickedDate} en AG Grid`);
                
                let firstNodeOfDay = null;
                let allNodesOfDay = [];
                let debugDates = [];  // Para debugging
                
                grid.forEachNode((node) => {
                  if (!node.data || !node.data.datetime) return;
                  
                  // Normalizar fecha a formato local consistente (sin conversión UTC)
                  const tradeDate = new Date(node.data.datetime);
                  const year = tradeDate.getFullYear();
                  const month = String(tradeDate.getMonth() + 1).padStart(2, '0');
                  const day = String(tradeDate.getDate()).padStart(2, '0');
                  const rowDate = `${year}-${month}-${day}`;
                  
                  // Debug: guardar primeras 5 fechas para ver formato
                  if (debugDates.length < 5) {
                    debugDates.push({ 
                      rowDate, 
                      originalDatetime: node.data.datetime,
                      clickedDate: clickedDate,
                      rowIndex: node.rowIndex 
                    });
                  }
                  
                  if (rowDate === clickedDate) {
                    allNodesOfDay.push(node);
                    // Guardar el primer trade de ese día (más reciente por ordenamiento descendente)
                    if (!firstNodeOfDay) {
                      firstNodeOfDay = node;
                    }
                  }
                });
                
                console.log(`🔍 Primeras fechas en grid:`, debugDates);
                console.log(`✨ ${allNodesOfDay.length} trades encontrados para ${clickedDate}`);
                
                if (firstNodeOfDay) {
                  // Navegar a la página que contiene el primer trade
                  const pageSize = grid.paginationGetPageSize();
                  const pageNumber = Math.floor(firstNodeOfDay.rowIndex / pageSize);
                  grid.paginationGoToPage(pageNumber);
                  
                  // Esperar a que la página cambie y luego hacer scroll
                  setTimeout(() => {
                    grid.ensureNodeVisible(firstNodeOfDay, 'top');
                    
                    // Flash cells para resaltar visualmente TODOS los trades del día
                    allNodesOfDay.forEach(node => {
                      grid.flashCells({
                        rowNodes: [node],
                        flashDelay: 500,
                        fadeDelay: 2500
                      });
                    });
                  }, 300);
                } else {
                  alert(`No hay trades para el ${clickedDate} en el período seleccionado`);
                }
              }, 500);
            }
          } else {
            console.log(`❌ Click en gráfico pero sin elementos`);
          }
        },
        plugins: {
          legend: { 
            display: true,
            position: 'top',
            labels: {
              color: '#94a3b8',
              font: { size: 11 },
              usePointStyle: true,
              padding: 10
            }
          },
          tooltip: {
            callbacks: {
              title: (context) => {
                const idx = context[0].dataIndex;
                const dateStr = dailyLabels[idx];
                // Parsear manualmente para evitar conversión de zona horaria
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                return `${dayNames[date.getDay()]} ${date.getDate()} de ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
              },
              label: (context) => {
                const value = context.parsed.y;
                if (value === null) return null;
                
                const idx = context.dataIndex;
                const labels = [];
                
                // Capital del día
                labels.push(`Capital: $${value.toLocaleString('en-US', {minimumFractionDigits: 2})}`);
                
                // Cambio vs día anterior
                if (idx > 0 && dailyData[idx-1]) {
                  const change = value - dailyData[idx-1];
                  const changePercent = (change / dailyData[idx-1] * 100);
                  const sign = change >= 0 ? '+' : '';
                  labels.push(`Cambio: ${sign}$${change.toFixed(2)} (${sign}${changePercent.toFixed(2)}%)`);
                }
                
                // Contar trades de ese día
                const dateStr = dailyLabels[idx];
                const dayTrades = (data.trades || []).filter(t => 
                  t.datetime && t.datetime.split('T')[0] === dateStr && t.is_closed
                );
                
                if (dayTrades.length > 0) {
                  const dayPL = dayTrades.reduce((sum, t) => sum + (t.pl_usd || 0), 0);
                  labels.push(`${dayTrades.length} operaciones: ${dayPL >= 0 ? '+' : ''}$${dayPL.toFixed(2)}`);
                } else {
                  labels.push('Sin operaciones cerradas');
                }
                
                labels.push('📊 Click para ver detalle');
                
                return labels;
              },
              footer: (context) => {
                return 'Click en el punto para ir a la tabla de trades';
              }
            }
          }
        },
        scales: {
          y: {
            // Ajustar eje Y según período: períodos cortos enfocados en capital actual, largos incluyen meta
            min: Math.floor(Math.min(...dailyData) * 0.98), // 2% debajo del mínimo
            max: (() => {
              const maxData = Math.max(...dailyData);
              const dataRange = maxData - Math.min(...dailyData);
              
              // Si el rango es pequeño (< $500), enfocarse en variaciones
              if (dataRange < 500) {
                return Math.ceil(maxData * 1.02); // Solo 2% arriba
              }
              // Si estamos cerca de la meta (>50%), mostrar meta
              else if (maxData / metaCapital > 0.5) {
                return metaCapital * 1.05;
              }
              // Caso intermedio
              else {
                return Math.ceil(maxData * 1.2); // 20% arriba
              }
            })(),
            ticks: { 
              color: '#94a3b8',
              callback: (value) => {
                return '$' + value.toLocaleString('en-US', {maximumFractionDigits: 0});
              }
            },
            grid: { color: 'rgba(71, 85, 105, 0.1)' },
            title: {
              display: false
            }
          },
          x: {
            ticks: { 
              color: '#94a3b8', 
              maxRotation: 45,
              autoSkip: true,
              maxTicksLimit: dailyLabels.length <= 30 ? dailyLabels.length : 20, // Mostrar todos si ≤30 días
              callback: function(value, index, ticks) {
                // Obtener la fecha del label usando el índice original del array
                const labelText = this.getLabelForValue(value);
                
                // Reconstruir fecha completa desde dailyLabels
                let fullDate = null;
                dailyLabels.forEach((dl, idx) => {
                  if (dl.slice(5) === labelText) {
                    // Parsear manualmente para evitar conversión de zona horaria
                    const [year, month, day] = dl.split('-').map(Number);
                    fullDate = new Date(year, month - 1, day);
                  }
                });
                
                if (!fullDate) return labelText;
                
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                const dayName = dayNames[fullDate.getDay()];
                const dayNum = String(fullDate.getDate()).padStart(2, '0');
                const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const monthName = monthNames[fullDate.getMonth()];
                
                // Mostrar día de semana + número + mes para claridad
                return `${dayName} ${dayNum} ${monthName}`;
              }
            },
            grid: { 
              display: true,
              color: 'rgba(71, 85, 105, 0.05)' // Grid muy sutil
            },
            title: {
              display: false
            }
          }
        }
      }
    });
    
    console.log(`   ✅ Gráfico ${chartKey} renderizado correctamente`);
  }

  function renderHourlyPerformance(trades, broker, suffix) {
    const ctx = document.getElementById(`chart-hourly${suffix}`);
    if (!ctx) return;
    
    // Agrupar trades por hora (9 AM - 4 PM = market hours)
    const hourlyPL = {};
    for (let hour = 9; hour <= 16; hour++) {
      hourlyPL[hour] = { pl: 0, count: 0 };
    }
    
    trades.forEach(trade => {
      if (!trade.datetime || !trade.pl_realized) return;
      
      const tradeDate = new Date(trade.datetime);
      const hour = tradeDate.getHours();
      
      if (hour >= 9 && hour <= 16) {
        hourlyPL[hour].pl += (trade.pl_realized || 0);
        hourlyPL[hour].count++;
      }
    });
    
    const hours = Object.keys(hourlyPL).sort();
    const plValues = hours.map(h => hourlyPL[h].pl);
    const counts = hours.map(h => hourlyPL[h].count);
    
    const chartKey = `hourly-${broker}`;
    if (chartsMap[chartKey]) chartsMap[chartKey].destroy();
    
    chartsMap[chartKey] = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: hours.map(h => `${h}:00`),
        datasets: [{
          label: 'P&L por Hora',
          data: plValues,
          backgroundColor: plValues.map(v => v >= 0 ? '#10b981' : '#ef4444'),
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => {
                const idx = context.dataIndex;
                const pl = plValues[idx];
                const count = counts[idx];
                return `P&L: $${pl.toFixed(2)} (${count} trades)`;
              }
            }
          }
        },
        scales: {
          y: {
            ticks: { 
              color: '#94a3b8',
              callback: (value) => '$' + value.toFixed(0)
            },
            grid: { color: 'rgba(71, 85, 105, 0.1)' }
          },
          x: {
            ticks: { color: '#94a3b8' },
            grid: { display: false }
          }
        }
      }
    });
  }

  function renderTopSymbolsGrid(data, broker, suffix) {
    const gridDiv = document.getElementById(`grid-top-symbols${suffix}`);
    if (!gridDiv) return;
    
    // Convertir trades a formato plano con datos agregados por símbolo
    const flatData = [];
    const symbolStats = {};
    
    (data.trades || []).forEach(trade => {
      if (!trade.is_closed) return;
      
      const symbol = trade.symbol;
      if (!symbolStats[symbol]) {
        symbolStats[symbol] = {
          pl_usd: 0,
          cost_basis: 0,
          count: 0,
          avg_price: 0,
          total_quantity: 0,
          first_date: trade.datetime,
          last_date: trade.datetime
        };
      }
      
      symbolStats[symbol].pl_usd += (trade.pl_usd || 0);
      symbolStats[symbol].cost_basis += Math.abs(trade.price * trade.quantity);
      symbolStats[symbol].count += 1;
      symbolStats[symbol].total_quantity += trade.quantity;
      
      // Actualizar fechas
      if (trade.datetime < symbolStats[symbol].first_date) {
        symbolStats[symbol].first_date = trade.datetime;
      }
      if (trade.datetime > symbolStats[symbol].last_date) {
        symbolStats[symbol].last_date = trade.datetime;
      }
      
      // Añadir fila individual con datos del símbolo agregados
      const stats = symbolStats[symbol];
      const pl_percent = stats.cost_basis > 0 ? (stats.pl_usd / stats.cost_basis * 100) : 0;
      
      flatData.push({
        // Datos del trade individual
        datetime: trade.datetime,
        side: trade.side,
        price: trade.price,
        quantity: trade.quantity,
        trade_pl_usd: trade.pl_usd || 0,
        
        // Datos agregados del símbolo
        symbol: symbol,
        symbol_count: stats.count,
        symbol_pl_usd: stats.pl_usd,
        symbol_pl_percent: pl_percent,
        symbol_total_quantity: stats.total_quantity,
        symbol_avg_price: stats.cost_basis / stats.total_quantity
      });
    });
    
    const columnDefs = [
      {
        field: 'symbol',
        headerName: 'Símbolo',
        sortable: true,
        filter: true,
        width: 120,
        pinned: 'left',
        cellStyle: { fontWeight: 'bold', color: '#10b981', backgroundColor: '#1e293b' }
      },
      {
        field: 'symbol_count',
        headerName: '# Ops',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 90,
        cellStyle: { fontWeight: 'bold', color: '#3b82f6' }
      },
      {
        field: 'symbol_pl_usd',
        headerName: 'P&L Total',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 140,
        cellRenderer: (params) => {
          const value = params.value || 0;
          const className = value >= 0 ? 'gain' : 'loss';
          return `<span class="${className}">${formatUSD(value, 2, true)}</span>`;
        }
      },
      {
        field: 'symbol_pl_percent',
        headerName: 'P&L %',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 110,
        cellRenderer: (params) => {
          const value = params.value || 0;
          const className = value >= 0 ? 'gain' : 'loss';
          return `<span class="${className}">${formatPercent(value, 2, true)}</span>`;
        }
      },
      {
        field: 'datetime',
        headerName: 'Fecha/Hora',
        sortable: true,
        filter: true,
        width: 160,
        valueFormatter: (params) => {
          if (!params.value) return '';
          const date = new Date(params.value);
          const weekday = date.toLocaleDateString('es-ES', { weekday: 'short' });
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const hour = String(date.getHours()).padStart(2, '0');
          const minute = String(date.getMinutes()).padStart(2, '0');
          return `${weekday.charAt(0).toUpperCase() + weekday.slice(1)} ${day}/${month}, ${hour}:${minute}`;
        }
      },
      {
        field: 'side',
        headerName: 'Lado',
        sortable: true,
        filter: true,
        width: 90,
        cellRenderer: (params) => {
          const icon = params.value === 'BUY' ? '📈' : '📉';
          const color = params.value === 'BUY' ? 'text-green-400' : 'text-red-400';
          return `<span class="${color}">${icon} ${params.value}</span>`;
        }
      },
      {
        field: 'price',
        headerName: 'Precio',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 110,
        valueFormatter: (params) => formatUSD(params.value, 2, false)
      },
      {
        field: 'quantity',
        headerName: 'Cantidad',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 110
      },
      {
        field: 'trade_pl_usd',
        headerName: 'P&L Op',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 120,
        cellRenderer: (params) => {
          const value = params.value || 0;
          const className = value >= 0 ? 'gain' : 'loss';
          return `<span class="${className}">${formatUSD(value, 2, true)}</span>`;
        }
      }
    ];
    
    const gridOptions = {
      columnDefs: columnDefs,
      rowData: flatData,
      defaultColDef: {
        resizable: true,
        sortable: true,
        filter: true
      },
      domLayout: 'normal',
      enableCellTextSelection: true,
      animateRows: true,
      pagination: true,
      paginationPageSize: 50,
      paginationPageSizeSelector: [25, 50, 100, 200],
      rowSelection: 'single'
    };
    
    const gridKey = `grid-top-symbols-${broker}`;
    
    // ✅ Usar AG Grid API en lugar de destroy/create
    if (gridsMap[gridKey]) {
      // Grid ya existe, solo actualizar datos con transición suave
      gridsMap[gridKey].setGridOption('rowData', flatData);
      console.log(`🔄 Grid Top Símbolos actualizado para ${broker} con ${flatData.length} operaciones`);
    } else {
      // Primera vez, crear el grid
      gridsMap[gridKey] = agGrid.createGrid(gridDiv, gridOptions);
      console.log(`✅ Grid Top Símbolos inicializado para ${broker} con ${flatData.length} operaciones (${Object.keys(symbolStats).length} símbolos)`);
    }
  }

  // ========================================================================
  // TABLA DE TRADES
  // ========================================================================

  function renderTable(trades, broker, suffix, maxTrades = 30) {
    const gridDiv = document.getElementById(`grid${suffix}`);
    if (!gridDiv) return;
    
    // Filtrar trades según el período seleccionado (currentDays)
    const now = new Date();
    let filteredTrades = trades;
    
    if (currentDays !== 'all') {
      const startDate = new Date(now);
      startDate.setDate(startDate.getDate() - currentDays);
      
      filteredTrades = trades.filter(t => {
        if (!t.datetime) return false;
        const tradeDate = new Date(t.datetime);
        return tradeDate >= startDate;
      });
      
      console.log(`📊 Filtrado de tabla: ${filteredTrades.length} trades de los últimos ${currentDays} días (de ${trades.length} totales)`);
    }
    
    // Ordenar por fecha descendente (más reciente primero)
    const sortedTrades = [...filteredTrades].sort((a, b) => {
      return new Date(b.datetime) - new Date(a.datetime);
    });
    
    // AG Grid mostrará TODOS los trades del período con paginación
    console.log(`📊 AG Grid mostrará ${sortedTrades.length} trades del período con paginación`);

    // Definir columnas de AG Grid
    const columnDefs = [
      // Columna de broker solo para la tab "all"
      ...(broker === 'all' ? [{
        field: 'broker',
        headerName: 'Broker',
        sortable: true,
        filter: true,
        width: 100,
        cellRenderer: (params) => {
          const brokerName = params.value?.toUpperCase() || '';
          const isSchwab = params.value === 'schwab';
          return `<span class="text-xs px-2 py-1 rounded ${isSchwab ? 'bg-blue-900 text-blue-300' : 'bg-orange-900 text-orange-300'}">${brokerName}</span>`;
        }
      }] : []),
      {
        field: 'datetime',
        headerName: 'Fecha',
        sortable: true,
        filter: true,
        width: 160,
        valueFormatter: (params) => {
          if (!params.value) return '';
          const date = new Date(params.value);
          const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
          const dayName = dayNames[date.getDay()];
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hour = String(date.getHours()).padStart(2, '0');
          const minute = String(date.getMinutes()).padStart(2, '0');
          // Formato: Mié 11/06, 14:30
          return `${dayName} ${month}/${day}, ${hour}:${minute}`;
        }
      },
      {
        field: 'symbol',
        headerName: 'Símbolo',
        sortable: true,
        filter: true,
        width: 110,
        cellStyle: { fontWeight: 'bold', color: '#10b981' }
      },
      {
        field: 'side',
        headerName: 'Lado',
        sortable: true,
        filter: true,
        width: 100,
        cellRenderer: (params) => {
          const icon = params.value === 'BUY' ? '📈' : '📉';
          const color = params.value === 'BUY' ? 'text-green-400' : 'text-red-400';
          return `<span class="${color}">${icon} ${params.value}</span>`;
        }
      },
      {
        field: 'quantity',
        headerName: 'Cantidad',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 120,
        valueFormatter: (params) => {
          const decimals = params.data.broker === 'coinbase' ? 8 : 2;
          return formatNumber(parseFloat(params.value || 0), decimals, false);
        }
      },
      {
        field: 'price',
        headerName: 'Precio',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 110,
        valueFormatter: (params) => formatUSD(parseFloat(params.value || 0), 2, false)
      },
      {
        field: 'total',
        headerName: 'Total',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 110,
        valueGetter: (params) => parseFloat(params.data.total || params.data.amount || 0),
        valueFormatter: (params) => formatUSD(params.value, 2, false)
      },
      {
        field: 'fee',
        headerName: 'Fee',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 90,
        valueFormatter: (params) => formatUSD(parseFloat(params.value || 0), 2, false)
      },
      {
        field: 'pl_usd',
        headerName: 'P&L USD',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 120,
        cellRenderer: (params) => {
          const value = params.value || 0;
          const className = value >= 0 ? 'gain' : 'loss';
          return `<span class="${className}">${formatUSD(value, 2, true)}</span>`;
        }
      },
      {
        field: 'pl_percent',
        headerName: 'P&L %',
        sortable: true,
        filter: true,
        type: 'numericColumn',
        width: 110,
        cellRenderer: (params) => {
          const value = params.value || 0;
          const className = value >= 0 ? 'gain' : 'loss';
          return `<span class="${className}">${formatPercent(value, 2, true)}</span>`;
        }
      }
    ];

    // Configuración del grid con paginación
    const gridOptions = {
      columnDefs: columnDefs,
      rowData: sortedTrades,  // TODOS los trades del período
      defaultColDef: {
        resizable: true,
        sortable: true,
        filter: true
      },
      domLayout: 'normal',
      enableCellTextSelection: true,
      animateRows: true,
      rowSelection: 'single',
      pagination: true,
      paginationPageSize: 50,  // 50 trades por página
      paginationPageSizeSelector: [25, 50, 100, 200],
      onRowClicked: (event) => {
        console.log('📊 Trade seleccionado:', event.data);
      }
    };

    // ✅ Usar AG Grid API en lugar de destroy/create
    const gridKey = `grid-${broker}`;
    if (gridsMap[gridKey]) {
      // Grid ya existe, solo actualizar datos
      gridsMap[gridKey].setGridOption('rowData', sortedTrades);
      console.log(`🔄 AG Grid actualizado para ${broker} con ${sortedTrades.length} trades`);
    } else {
      // Primera vez, crear el grid
      gridsMap[gridKey] = agGrid.createGrid(gridDiv, gridOptions);
      console.log(`✅ AG Grid inicializado para ${broker} con ${sortedTrades.length} trades (paginación: 50 por página)`);
    }
  }

  // ========================================================================
  // WINNERS/LOSERS
  // ========================================================================

  function renderWinnersLosers(trades, broker, suffix, topN = 5) {
    const symbolPL = {};
    
    trades.forEach(t => {
      if (!symbolPL[t.symbol]) {
        symbolPL[t.symbol] = { pl_usd: 0, pl_percent: 0, cost_basis: 0, trades: 0 };
      }
      symbolPL[t.symbol].pl_usd += (t.pl_usd || 0);
      
      // Calcular P&L % acumulado: necesitamos sumar cost_basis y P&L USD
      const tradeCost = Math.abs(t.price * t.quantity);
      symbolPL[t.symbol].cost_basis += tradeCost;
      symbolPL[t.symbol].trades += 1;
    });

    // Calcular P&L % total para cada símbolo
    Object.values(symbolPL).forEach(stats => {
      if (stats.cost_basis > 0) {
        stats.pl_percent = (stats.pl_usd / stats.cost_basis) * 100;
      }
    });

    const sorted = Object.entries(symbolPL)
      .map(([sym, stats]) => ({ symbol: sym, ...stats }))
      .sort((a, b) => b.pl_usd - a.pl_usd);

    const winners = sorted.slice(0, topN);
    const losers = sorted.slice(-topN).reverse();

    const winnersEl = document.getElementById(`winners-list${suffix}`);
    const losersEl = document.getElementById(`losers-list${suffix}`);
    
    if (winnersEl) {
      winnersEl.innerHTML = winners.map(w => `
        <div class="bg-slate-700/30 p-3 rounded flex justify-between hover:bg-slate-700/50 transition">
          <div>
            <span class="font-bold">${w.symbol}</span>
            <p class="text-xs text-slate-400">${w.trades} ops</p>
          </div>
          <div class="text-right">
            <span class="gain text-lg">+$${Math.abs(w.pl_usd).toFixed(2)}</span>
            <p class="text-xs gain">+${w.pl_percent.toFixed(2)}%</p>
          </div>
        </div>
      `).join('');
    }

    if (losersEl) {
      losersEl.innerHTML = losers.map(l => `
        <div class="bg-slate-700/30 p-3 rounded flex justify-between hover:bg-slate-700/50 transition">
          <div>
            <span class="font-bold">${l.symbol}</span>
            <p class="text-xs text-slate-400">${l.trades} ops</p>
          </div>
          <div class="text-right">
            <span class="loss text-lg">-$${Math.abs(l.pl_usd).toFixed(2)}</span>
            <p class="text-xs loss">${l.pl_percent.toFixed(2)}%</p>
          </div>
        </div>
      `).join('');
    }
  }

  // ========================================================================
  // CONTROLS
  // ========================================================================

  function switchTab(tab) {
    // Remover active de todos
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    // Activar el seleccionado
    document.getElementById(`tab-btn-${tab}`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    // Actualizar broker activo y stats counter
    currentBroker = tab;
    updateStatsCounter();
  }

  function refreshData() {
    requestData();  // Usar WebSocket
  }

  /**
   * Formatear input de meta para mostrar con comas
   */
  function formatMetaInput(broker) {
    const input = document.getElementById(`meta-capital-${broker}`);
    if (!input) return;
    
    const value = parseFloat(input.value.replace(/,/g, ''));
    if (!isNaN(value)) {
      input.value = value.toLocaleString('en-US');
    }
  }

  /**
   * Quitar formato de comas para editar
   */
  function unformatMetaInput(broker) {
    const input = document.getElementById(`meta-capital-${broker}`);
    if (!input) return;
    
    const value = parseFloat(input.value.replace(/,/g, ''));
    if (!isNaN(value)) {
      input.value = value;
    }
  }

  /**
   * Restaurar fecha inicial al primer trade
   */
  function restoreInitialDate(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data || !data.trades || data.trades.length === 0) return;
    
    // Encontrar el trade más antiguo
    const firstTrade = data.trades.reduce((oldest, trade) => {
      return trade.datetime < oldest.datetime ? trade : oldest;
    });
    
    const firstDate = firstTrade.datetime.split('T')[0];
    const input = document.getElementById(`fecha-inicial-${broker}`);
    if (input) {
      input.value = firstDate;
      updateCapitalGoal(broker);
      console.log(`✅ Fecha inicial restaurada a: ${firstDate}`);
    }
  }

  /**
   * Actualizar el cálculo de progreso cuando el usuario cambia la meta o fecha
   */
  function updateCapitalGoal(broker) {
    // Obtener los datos actuales del broker
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data) return;
    
    const currentCapital = data.capital?.current || 5000;
    const metaInput = document.getElementById(`meta-capital-${broker}`);
    const metaCapital = metaInput ? parseFloat(metaInput.value.replace(/,/g, '')) : 25000;
    
    // Recalcular progreso
    const progressPct = Math.min((currentCapital / metaCapital) * 100, 100);
    document.getElementById(`progress-pct-${broker}`).textContent = `${progressPct.toFixed(1)}%`;
    
    // Texto corto de progreso
    const remaining = metaCapital - currentCapital;
    const progressTextShort = remaining > 0 ? `${formatUSD(remaining, 0, false)}` : '¡Alcanzada!';
    const progressTextShortElement = document.getElementById(`progress-text-short-${broker}`);
    if (progressTextShortElement) {
      progressTextShortElement.textContent = progressTextShort;
    }
    
    // Texto largo de progreso
    const progressText = remaining > 0 
      ? `${formatUSD(remaining, 2, false)}`
      : `+${formatUSD(Math.abs(remaining), 2, false)}`;
    document.getElementById(`progress-text-${broker}`).textContent = progressText;
    
    // Calcular días restantes y transcurridos
    const fechaInicial = document.getElementById(`fecha-inicial-${broker}`)?.value || '2025-10-28';
    const fechaMeta = document.getElementById(`meta-fecha-${broker}`)?.value || '2026-12-31';
    const today = new Date();
    const startDate = new Date(fechaInicial);
    const endDate = new Date(fechaMeta);
    
    const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
    const daysRemaining = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));
    const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    const daysRemainingElement = document.getElementById(`days-remaining-${broker}`);
    const daysElapsedElement = document.getElementById(`days-elapsed-${broker}`);
    
    if (daysRemainingElement) {
      daysRemainingElement.textContent = daysRemaining > 0 ? daysRemaining : '0';
    }
    
    if (daysElapsedElement) {
      daysElapsedElement.textContent = `${daysElapsed} días transcurridos`;
    }
    
    // Guardar en localStorage para persistir entre sesiones
    const settings = {
      metaCapital: metaCapital,
      metaFecha: fechaMeta,
      fechaInicial: fechaInicial
    };
    localStorage.setItem(`tradeplus-goal-${broker}`, JSON.stringify(settings));
    
    console.log(`✅ Meta actualizada para ${broker}: $${metaCapital.toLocaleString()} - ${settings.metaFecha}`);
    
    // Re-renderizar gráfica con nuevo rango
    const suffix = broker === 'schwab' ? '-schwab' : (broker === 'coinbase' ? '-coinbase' : '-all');
    renderCapitalChart(data, broker, suffix);
  }

  /**
   * Cargar metas guardadas desde localStorage al iniciar
   */
  function loadSavedGoals() {
    ['schwab', 'coinbase', 'all'].forEach(broker => {
      const saved = localStorage.getItem(`tradeplus-goal-${broker}`);
      if (saved) {
        try {
          const settings = JSON.parse(saved);
          const metaInput = document.getElementById(`meta-capital-${broker}`);
          const fechaMetaInput = document.getElementById(`meta-fecha-${broker}`);
          const fechaInicialInput = document.getElementById(`fecha-inicial-${broker}`);
          
          if (metaInput && settings.metaCapital) {
            metaInput.value = settings.metaCapital.toLocaleString('en-US');
          }
          if (fechaMetaInput && settings.metaFecha) {
            fechaMetaInput.value = settings.metaFecha;
          }
          if (fechaInicialInput && settings.fechaInicial) {
            fechaInicialInput.value = settings.fechaInicial;
          }
          
          console.log(`✅ Meta cargada para ${broker}: $${settings.metaCapital?.toLocaleString()} - ${settings.metaFecha}`);
        } catch (e) {
          console.error(`Error cargando meta para ${broker}:`, e);
        }
      }
    });
  }

  // ========================================================================
  // AG-GRID MODAL FUNCTIONS
  // ========================================================================
  
  let gridApi = null;

  function showAgGridModal(rowData, columnDefs, title) {
    const modal = document.getElementById('ag-grid-modal');
    const modalTitle = document.getElementById('modal-title');
    const container = document.getElementById('ag-grid-container');
    
    // Configurar título
    modalTitle.textContent = title;
    
    // Limpiar grid anterior
    container.innerHTML = '';
    
    // Configuración de Ag-Grid
    const gridOptions = {
      columnDefs: columnDefs,
      rowData: rowData,
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        flex: 1,
        minWidth: 100
      },
      pagination: true,
      paginationPageSize: 20,
      enableCellTextSelection: true,
      ensureDomOrder: true,
      animateRows: true,
      domLayout: 'normal'
    };
    
    // Crear grid
    gridApi = agGrid.createGrid(container, gridOptions);
    
    // Mostrar modal
    modal.classList.add('active');
  }

  function closeAgGridModal() {
    const modal = document.getElementById('ag-grid-modal');
    modal.classList.remove('active');
    if (gridApi) {
      gridApi.destroy();
      gridApi = null;
    }
    // Destruir grids del modal de posiciones si existen
    if (window.closedGridApi) {
      window.closedGridApi.destroy();
      window.closedGridApi = null;
    }
    if (window.openGridApi) {
      window.openGridApi.destroy();
      window.openGridApi = null;
    }
  }

  // ========================================================================
  // CLICK HANDLERS - OPERACIONES CERRADAS
  // ========================================================================

  function showClosedOperations(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data || !data.trades) return;

    // Filtrar operaciones cerradas (pl_usd !== 0)
    const closedTrades = data.trades.filter(t => t.pl_usd && t.pl_usd !== 0);

    const columnDefs = [
      { field: 'datetime', headerName: 'Fecha', valueFormatter: p => new Date(p.value).toLocaleString('es-ES') },
      { field: 'symbol', headerName: 'Símbolo' },
      { field: 'side', headerName: 'Lado' },
      { field: 'quantity', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'price', 
        headerName: 'Precio', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(parseFloat(p.value), decimals, false);
        }
      },
      { field: 'fee', headerName: 'Fee', type: 'numericColumn', valueFormatter: p => formatUSD(parseFloat(p.value), 2, false) },
      { 
        field: 'pl_usd', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => formatUSD(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { 
        field: 'pl_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => formatPercent(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      }
    ];

    const brokerName = broker === 'schwab' ? 'Schwab' : (broker === 'coinbase' ? 'Coinbase' : 'Todos los Brokers');
    showAgGridModal(closedTrades, columnDefs, `📊 Operaciones Cerradas - ${brokerName} (${closedTrades.length} ops)`);
  }

  // ========================================================================
  // CLICK HANDLERS - TODAS LAS OPERACIONES
  // ========================================================================

  function showAllOperations(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data || !data.trades) return;

    const columnDefs = [
      { field: 'datetime', headerName: 'Fecha', valueFormatter: p => new Date(p.value).toLocaleString('es-ES') },
      { field: 'symbol', headerName: 'Símbolo' },
      { field: 'side', headerName: 'Lado' },
      { field: 'quantity', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'price', 
        headerName: 'Precio', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(parseFloat(p.value), decimals, false);
        }
      },
      { field: 'fee', headerName: 'Fee', type: 'numericColumn', valueFormatter: p => formatUSD(parseFloat(p.value), 2, false) },
      { 
        field: 'pl_usd', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => p.value === 0 ? 'Abierta' : formatUSD(p.value, 2, true),
        cellStyle: p => {
          if (p.value === 0) return { color: '#94a3b8' };
          return { color: p.value >= 0 ? '#10b981' : '#ef4444' };
        }
      },
      { 
        field: 'pl_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => p.value === 0 ? '-' : formatPercent(p.value, 2, true),
        cellStyle: p => {
          if (p.value === 0) return { color: '#94a3b8' };
          return { color: p.value >= 0 ? '#10b981' : '#ef4444' };
        }
      }
    ];

    const brokerName = broker === 'schwab' ? 'Schwab' : (broker === 'coinbase' ? 'Coinbase' : 'Todos los Brokers');
    showAgGridModal(data.trades, columnDefs, `📋 Todas las Operaciones - ${brokerName} (${data.trades.length} trades)`);
  }

  // ========================================================================
  // CLICK HANDLER - RESUMEN DE POSICIONES (CERRADAS + ABIERTAS CON TABS)
  // ========================================================================

  function showPositionsSummary(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data) return;

    const closedTrades = data.trades ? data.trades.filter(t => t.pl_usd && t.pl_usd !== 0) : [];
    const openPos = data.positions?.open_detail || [];
    
    const brokerName = broker === 'schwab' ? 'Schwab' : (broker === 'coinbase' ? 'Coinbase' : 'Todos los Brokers');
    
    // Crear modal personalizado con tabs
    const modal = document.getElementById('ag-grid-modal');
    const modalTitle = document.getElementById('modal-title');
    const container = document.getElementById('ag-grid-container');
    
    modalTitle.textContent = `📊 Resumen de Posiciones - ${brokerName}`;
    
    // HTML personalizado con tabs
    container.innerHTML = `
      <div style="height: 100%; display: flex; flex-direction: column;">
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #475569; padding-bottom: 10px;">
          <button id="tab-closed-btn" onclick="switchPositionsTab('closed')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s;">
            ✅ Cerradas (${closedTrades.length})
          </button>
          <button id="tab-open-btn" onclick="switchPositionsTab('open')" style="padding: 10px 20px; background: #334155; color: #94a3b8; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s;">
            📈 Abiertas (${openPos.length})
          </button>
        </div>
        <div id="positions-grid-closed" class="ag-theme-alpine-dark" style="flex: 1; display: block;"></div>
        <div id="positions-grid-open" class="ag-theme-alpine-dark" style="flex: 1; display: none;"></div>
      </div>
    `;
    
    // Configurar grid de cerradas con formateo centralizado
    const closedColumnDefs = [
      { field: 'datetime', headerName: 'Fecha', valueFormatter: p => new Date(p.value).toLocaleString('es-ES') },
      { field: 'symbol', headerName: 'Símbolo' },
      { field: 'side', headerName: 'Lado' },
      { field: 'quantity', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'price', 
        headerName: 'Precio', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(parseFloat(p.value), decimals, false);
        }
      },
      { field: 'fee', headerName: 'Fee', type: 'numericColumn', valueFormatter: p => formatUSD(parseFloat(p.value), 2, false) },
      { 
        field: 'pl_usd', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => formatUSD(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { 
        field: 'pl_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => formatPercent(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      }
    ];
    
    const closedGridOptions = {
      columnDefs: closedColumnDefs,
      rowData: closedTrades,
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        flex: 1,
        minWidth: 100
      },
      pagination: true,
      paginationPageSize: 20,
      enableCellTextSelection: true,
      ensureDomOrder: true,
      animateRows: true,
      domLayout: 'normal'
    };
    
    // Configurar grid de abiertas con formateo centralizado
    const openColumnDefs = [
      { field: 'symbol', headerName: 'Símbolo' },
      { field: 'qty', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'avg_cost', 
        headerName: 'Costo Prom.', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(p.value, decimals, false);
        }
      },
      { 
        field: 'current_price', 
        headerName: 'Precio Actual', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(p.value, decimals, false);
        }
      },
      { field: 'cost_basis', headerName: 'Base de Costo', type: 'numericColumn', valueFormatter: p => formatUSD(p.value, 2, false) },
      { field: 'current_value', headerName: 'Valor Actual', type: 'numericColumn', valueFormatter: p => formatUSD(p.value, 2, false) },
      { 
        field: 'unrealized_pl', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => formatUSD(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { 
        field: 'unrealized_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => formatPercent(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { field: 'entries', headerName: 'Entradas', type: 'numericColumn' }
    ];
    
    const openGridOptions = {
      columnDefs: openColumnDefs,
      rowData: openPos,
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        flex: 1,
        minWidth: 100
      },
      pagination: true,
      paginationPageSize: 20,
      enableCellTextSelection: true,
      ensureDomOrder: true,
      animateRows: true,
      domLayout: 'normal'
    };
    
    // Crear ambos grids
    window.closedGridApi = agGrid.createGrid(document.getElementById('positions-grid-closed'), closedGridOptions);
    window.openGridApi = agGrid.createGrid(document.getElementById('positions-grid-open'), openGridOptions);
    
    // Mostrar modal
    modal.classList.add('active');
  }

  // Función para cambiar entre tabs del modal de posiciones
  window.switchPositionsTab = function(tab) {
    const closedBtn = document.getElementById('tab-closed-btn');
    const openBtn = document.getElementById('tab-open-btn');
    const closedGrid = document.getElementById('positions-grid-closed');
    const openGrid = document.getElementById('positions-grid-open');
    
    if (tab === 'closed') {
      closedBtn.style.background = '#10b981';
      closedBtn.style.color = 'white';
      openBtn.style.background = '#334155';
      openBtn.style.color = '#94a3b8';
      closedGrid.style.display = 'block';
      openGrid.style.display = 'none';
    } else {
      closedBtn.style.background = '#334155';
      closedBtn.style.color = '#94a3b8';
      openBtn.style.background = '#f59e0b';
      openBtn.style.color = 'white';
      closedGrid.style.display = 'none';
      openGrid.style.display = 'block';
    }
  };

  // ========================================================================
  // CLICK HANDLERS - POSICIONES ABIERTAS
  // ========================================================================

  function showOpenPositions(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data || !data.positions || !data.positions.open_detail) return;

    const openPos = data.positions.open_detail;

    const columnDefs = [
      { field: 'symbol', headerName: 'Símbolo' },
      { field: 'qty', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'avg_cost', 
        headerName: 'Costo Prom.', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(p.value, decimals, false);
        }
      },
      { 
        field: 'current_price', 
        headerName: 'Precio Actual', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(p.value, decimals, false);
        }
      },
      { field: 'cost_basis', headerName: 'Base de Costo', type: 'numericColumn', valueFormatter: p => formatUSD(p.value, 2, false) },
      { field: 'current_value', headerName: 'Valor Actual', type: 'numericColumn', valueFormatter: p => formatUSD(p.value, 2, false) },
      { 
        field: 'unrealized_pl', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => formatUSD(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { 
        field: 'unrealized_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => formatPercent(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { field: 'entries', headerName: 'Entradas', type: 'numericColumn' }
    ];

    const brokerName = broker === 'schwab' ? 'Schwab' : (broker === 'coinbase' ? 'Coinbase' : 'Todos los Brokers');
    showAgGridModal(openPos, columnDefs, `📈 Posiciones Abiertas - ${brokerName} (${openPos.length} posiciones)`);
  }

  // INIT - Conectar WebSocket al cargar página
  window.addEventListener('load', () => {
    console.log('🚀 Iniciando TradePlus Journal con WebSocket');
    
    // Cargar metas guardadas
    loadSavedGoals();
    
    // Conectar WebSocket
    connectWebSocket();
    
    // Configurar event listeners del modal (después de que el DOM esté listo)
    // Cerrar con ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAgGridModal();
    });

    // Cerrar al hacer click fuera
    const modal = document.getElementById('ag-grid-modal');
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target.id === 'ag-grid-modal') closeAgGridModal();
      });
    }
  });
</script>

<!-- Modal Ag-Grid -->
<div id="ag-grid-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title" class="text-2xl font-bold"></h2>
      <button class="modal-close-btn" onclick="closeAgGridModal()">✕</button>
    </div>
    <div class="modal-body">
      <div id="ag-grid-container" class="ag-theme-alpine-dark" style="height: 100%; width: 100%;"></div>
    </div>
  </div>
</div>

</body>
</html>
