<!DOCTYPE html>
<html>
<head>
    <title>Debug Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <h1>Debug Charts - DiagnÃ³stico</h1>
    
    <div style="margin: 20px;">
        <h3>Estado de la conexiÃ³n:</h3>
        <div id="status">Conectando...</div>
        <div id="websocket-status">WebSocket: Desconectado</div>
        <div id="data-received">Datos: No recibidos</div>
        <div id="chartjs-status">Chart.js: Verificando...</div>
    </div>
    
    <div style="margin: 20px;">
        <h3>Prueba de Chart.js:</h3>
        <canvas id="test-chart" width="400" height="200"></canvas>
    </div>
    
    <div style="margin: 20px;">
        <h3>Datos recibidos:</h3>
        <pre id="data-preview" style="background: #f0f0f0; padding: 10px; max-height: 300px; overflow-y: auto;">Esperando datos...</pre>
    </div>
    
    <script>
        // Verificar Chart.js
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                document.getElementById('chartjs-status').textContent = 'Chart.js: âœ… Disponible';
                
                // Crear grÃ¡fico de prueba
                const ctx = document.getElementById('test-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May'],
                        datasets: [{
                            label: 'Prueba',
                            data: [10, 20, 15, 25, 30],
                            borderColor: 'blue',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'GrÃ¡fico de Prueba - Chart.js Funcionando'
                            }
                        }
                    }
                });
            } else {
                document.getElementById('chartjs-status').textContent = 'Chart.js: âŒ No disponible';
            }
        }, 1000);
        
        // Conectar WebSocket
        const wsUrl = `ws://${window.location.host}/ws/journal`;
        console.log('ðŸ”Œ Conectando a WebSocket:', wsUrl);
        document.getElementById('status').textContent = 'Conectando a WebSocket...';
        
        const ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
            console.log('âœ… WebSocket conectado');
            document.getElementById('websocket-status').textContent = 'WebSocket: âœ… Conectado';
            document.getElementById('status').textContent = 'ConexiÃ³n establecida, solicitando datos...';
            
            // Solicitar datos
            ws.send(JSON.stringify({ broker: 'all', days: 30 }));
            ws.send(JSON.stringify({ broker: 'schwab', days: 30 }));
            ws.send(JSON.stringify({ broker: 'coinbase', days: 30 }));
        };
        
        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                console.log('ðŸ“¨ Mensaje recibido:', message);
                document.getElementById('data-received').textContent = `Datos: âœ… Recibidos (${message.broker || 'all'})`;
                
                // Mostrar preview de datos
                document.getElementById('data-preview').textContent = JSON.stringify(message, null, 2);
                
                // Verificar si hay datos de evoluciÃ³n
                if (message.data) {
                    if (message.data.evolution) {
                        console.log('ðŸ“Š Evolution data:', message.data.evolution.length, 'puntos');
                        document.getElementById('status').textContent += ' | Evolution: âœ…';
                    } else {
                        console.log('âš ï¸ No hay datos de evolution');
                        document.getElementById('status').textContent += ' | Evolution: âŒ';
                    }
                    
                    if (message.data.stats) {
                        console.log('ðŸ“ˆ Stats data:', message.data.stats);
                        document.getElementById('status').textContent += ' | Stats: âœ…';
                    } else {
                        console.log('âš ï¸ No hay datos de stats');
                        document.getElementById('status').textContent += ' | Stats: âŒ';
                    }
                    
                    if (message.data.trades) {
                        console.log('ðŸ’¼ Trades data:', message.data.trades.length, 'trades');
                        document.getElementById('status').textContent += ' | Trades: âœ…';
                    } else {
                        console.log('âš ï¸ No hay datos de trades');
                        document.getElementById('status').textContent += ' | Trades: âŒ';
                    }
                }
                
            } catch (error) {
                console.error('âŒ Error procesando mensaje:', error);
                document.getElementById('status').textContent = 'Error procesando mensaje: ' + error.message;
            }
        };
        
        ws.onerror = (error) => {
            console.error('âŒ WebSocket error:', error);
            document.getElementById('websocket-status').textContent = 'WebSocket: âŒ Error';
            document.getElementById('status').textContent = 'Error de conexiÃ³n WebSocket';
        };
        
        ws.onclose = () => {
            console.log('ðŸ”Œ WebSocket cerrado');
            document.getElementById('websocket-status').textContent = 'WebSocket: ðŸ”Œ Cerrado';
        };
    </script>
</body>
</html>