<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä JOURNAL - TradePlus V5</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  
  <!-- Ag-Grid Community -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-grid.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-theme-alpine-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/dist/ag-grid-community.min.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    * {
      --color-emerald: #10b981;
      --color-red: #ef4444;
      --color-slate-900: #0f172a;
      --color-slate-800: #1e293b;
      --color-slate-700: #334155;
      --color-text-primary: #e2e8f0;
      --color-text-secondary: #94a3b8;
    }
    
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--color-text-primary);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .kpi-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(71, 85, 105, 0.5);
      transform: translateY(-2px);
    }
    
    .chart-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }
    
    .gain {
      color: var(--color-emerald);
      font-weight: 600;
    }
    
    .loss {
      color: var(--color-red);
      font-weight: 600;
    }
    
    .tab-btn {
      border-bottom: 3px solid transparent;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--color-text-secondary);
    }
    
    .tab-btn.active {
      border-bottom-color: var(--color-emerald);
      color: var(--color-emerald);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    
    .date-filter-btn {
      background: rgba(51, 65, 85, 0.5);
      color: #94a3b8;
      border: 1px solid rgba(71, 85, 105, 0.3);
    }
    
    .date-filter-btn:hover {
      background: rgba(71, 85, 105, 0.8);
      color: #e2e8f0;
    }
    
    .date-filter-btn.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(16, 185, 129, 0.3);
      border-top: 3px solid var(--color-emerald);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .table-row {
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      transition: background 0.2s ease;
    }
    
    .table-row:hover {
      background: rgba(16, 185, 129, 0.05);
    }
    
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    
    /* Modal Ag-Grid Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 12px;
      width: 95%;
      max-width: 1400px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #475569;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-body {
      flex: 1;
      overflow: hidden;
      padding: 20px;
    }
    
    .ag-theme-alpine-dark {
      --ag-background-color: #1e293b;
      --ag-header-background-color: #334155;
      --ag-odd-row-background-color: #1e293b;
      --ag-row-hover-color: rgba(16, 185, 129, 0.1);
      --ag-border-color: #475569;
      --ag-header-foreground-color: #94a3b8;
      --ag-foreground-color: #e2e8f0;
    }
    
    .modal-close-btn {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .modal-close-btn:hover {
      background: #334155;
      color: #e2e8f0;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="sticky top-0 z-50 backdrop-blur-lg bg-slate-900/80 border-b border-slate-700/50">
  <div class="max-w-7xl mx-auto px-6 py-4">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h1 class="text-3xl font-bold">üìä JOURNAL</h1>
        <p class="text-slate-400 text-sm">An√°lisis de trading en tiempo real</p>
      </div>
      <div class="flex gap-4 items-center">
        <button onclick="refreshData()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-semibold transition">
          üîÑ Actualizar
        </button>
        <span class="text-slate-400 text-sm">
          √öltima actualizaci√≥n: <span id="last-update" class="text-emerald-400">cargando...</span>
        </span>
      </div>
    </div>
    
    <!-- FILTRO DE FECHAS (SIEMPRE VISIBLE) -->
    <div class="flex items-center gap-4 bg-slate-800/50 rounded-lg p-3">
      <span class="text-slate-400 font-semibold text-sm">üìÖ PER√çODO:</span>
      <div class="flex gap-2">
        <button onclick="changeDays(7)" id="btn-7d" class="date-filter-btn px-4 py-2 rounded-lg font-semibold transition">
          7 d√≠as
        </button>
        <button onclick="changeDays(30)" id="btn-30d" class="date-filter-btn active px-4 py-2 rounded-lg font-semibold transition">
          30 d√≠as
        </button>
        <button onclick="changeDays(90)" id="btn-90d" class="date-filter-btn px-4 py-2 rounded-lg font-semibold transition">
          90 d√≠as
        </button>
        <button onclick="changeDays(365)" id="btn-365d" class="date-filter-btn px-4 py-2 rounded-lg font-semibold transition">
          1 a√±o
        </button>
        <button onclick="showCustomDatePicker()" id="btn-custom" class="date-filter-btn px-4 py-2 rounded-lg font-semibold transition">
          üìÜ Custom
        </button>
      </div>
      <div class="ml-auto flex flex-col items-end">
        <span id="current-period-display" class="text-emerald-400 font-bold">
          √öltimos 30 d√≠as
        </span>
        <span id="current-period-stats" class="text-slate-400 text-xs mt-1">
          Cargando...
        </span>
      </div>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="max-w-7xl mx-auto px-6 py-8">

  <!-- TABS -->
  <div class="flex gap-0 mb-8 border-b border-slate-700">
    <button id="tab-btn-schwab" onclick="switchTab('schwab')" class="tab-btn active">
      üìà SCHWAB (<span id="count-schwab">-</span> ops)
    </button>
    <button id="tab-btn-coinbase" onclick="switchTab('coinbase')" class="tab-btn">
      ü™ô COINBASE (<span id="count-coinbase">-</span> ops)
    </button>
    <button id="tab-btn-all" onclick="switchTab('all')" class="tab-btn">
      üåê TODOS (<span id="count-all">-</span> ops)
    </button>
  </div>

  <!-- TAB SCHWAB -->
  <div id="tab-schwab" class="tab-content active">
    
    <!-- KPIs Row 1 - M√©tricas principales de P&L -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all" onclick="showAllOperations('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Total Ops</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-ops">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-pl-realized" style="color: var(--color-emerald);">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-schwab-pl-realized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-pl-unrealized">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-schwab-pl-unrealized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-purple-500 transition-all" onclick="showPositionsSummary('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Posiciones</p>
        <p class="text-2xl font-bold mt-2">
          <span class="gain" id="kpi-schwab-pos-closed">-</span> / 
          <span class="text-slate-400" id="kpi-schwab-pos-open">-</span>
        </p>
        <p class="text-xs text-slate-400 mt-1">Cerr / Abier</p>
      </div>
    </div>
    
    <!-- KPIs Row 2 - M√©tricas de rendimiento -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado %</p>
        <p class="text-3xl font-bold mt-2 gain" id="kpi-schwab-pl-realized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Cerradas)</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('schwab')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized %</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-pl-unrealized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Abiertas)</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Win Rate</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-wr">-</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Profit Factor</p>
        <p class="text-3xl font-bold mt-2" id="kpi-schwab-pf">-</p>
      </div>
    </div>
    
    <!-- Posiciones Abiertas -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">üìä Posiciones Abiertas</h3>
      <div id="open-positions-schwab" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <!-- Capital + Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <!-- Capital Card -->
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üí∞ Capital Actual</h3>
        <p class="text-4xl font-bold gain mb-2" id="capital-actual-schwab">$-</p>
        <p class="text-sm text-slate-400 mb-4">Meta EOY 2026: $25,000</p>
        
        <div class="mt-6 bg-emerald-900/20 rounded p-4">
          <div class="flex justify-between mb-2">
            <span class="text-sm text-slate-400">Progreso</span>
            <span class="text-sm font-bold gain" id="progress-pct-schwab">0%</span>
          </div>
          <div class="w-full bg-slate-700 rounded h-3 overflow-hidden">
            <div class="bg-emerald-500 h-3 rounded transition-all duration-500" id="progress-bar-schwab" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- Capital Evolution Chart -->
      <div class="chart-card lg:col-span-2">
        <h3 class="text-lg font-bold mb-4">üìà Evoluci√≥n de Capital</h3>
        <canvas id="chart-capital-schwab" height="200"></canvas>
      </div>
    </div>

    <!-- P&L Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üìä P&L Acumulado (Diario)</h3>
        <canvas id="chart-pl-daily-schwab" height="250"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üéØ Top S√≠mbolos</h3>
        <canvas id="chart-symbols-schwab" height="250"></canvas>
      </div>
    </div>

    <!-- Trades Table -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">üìã Detalle de Trades (√∫ltimos 30)</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="border-b border-slate-600">
            <tr class="text-slate-400 text-xs uppercase">
              <th class="text-left py-3 px-4">Fecha</th>
              <th class="text-left py-3 px-4">S√≠mbolo</th>
              <th class="text-left py-3 px-4">Lado</th>
              <th class="text-right py-3 px-4">Cantidad</th>
              <th class="text-right py-3 px-4">Precio</th>
              <th class="text-right py-3 px-4">Total</th>
              <th class="text-right py-3 px-4">Fee</th>
              <th class="text-right py-3 px-4">P&L USD</th>
              <th class="text-right py-3 px-4">P&L %</th>
            </tr>
          </thead>
          <tbody id="tbody-schwab"></tbody>
        </table>
      </div>
    </div>

    <!-- Top Winners/Losers -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">ü•á Top 5 Ganadores</h3>
        <div id="winners-list-schwab" class="space-y-3"></div>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üîª Top 5 Perdedores</h3>
        <div id="losers-list-schwab" class="space-y-3"></div>
      </div>
    </div>

  </div>

  <!-- TAB COINBASE -->
  <div id="tab-coinbase" class="tab-content">
    
    <!-- KPIs Row 1 - M√©tricas principales de P&L -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all" onclick="showAllOperations('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Total Ops</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-ops">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-pl-realized" style="color: var(--color-emerald);">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-coinbase-pl-realized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-pl-unrealized">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-coinbase-pl-unrealized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-purple-500 transition-all" onclick="showPositionsSummary('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Posiciones</p>
        <p class="text-2xl font-bold mt-2">
          <span class="gain" id="kpi-coinbase-pos-closed">-</span> / 
          <span class="text-slate-400" id="kpi-coinbase-pos-open">-</span>
        </p>
        <p class="text-xs text-slate-400 mt-1">Cerr / Abier</p>
      </div>
    </div>
    
    <!-- KPIs Row 2 - M√©tricas de rendimiento -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado %</p>
        <p class="text-3xl font-bold mt-2 gain" id="kpi-coinbase-pl-realized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Cerradas)</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('coinbase')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized %</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-pl-unrealized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Abiertas)</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Win Rate</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-wr">-</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Profit Factor</p>
        <p class="text-3xl font-bold mt-2" id="kpi-coinbase-pf">-</p>
      </div>
    </div>
    
    <!-- Posiciones Abiertas -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">üìä Posiciones Abiertas</h3>
      <div id="open-positions-coinbase" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <!-- Performance por Hora -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">‚è∞ Performance por Hora del D√≠a</h3>
      <canvas id="chart-hourly-coinbase" height="200"></canvas>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üí∞ Capital Actual</h3>
        <p class="text-4xl font-bold gain mb-2" id="capital-actual-coinbase">$-</p>
        <p class="text-sm text-slate-400 mb-4">Meta EOY 2026: $25,000</p>
        <div class="mt-6 bg-emerald-900/20 rounded p-4">
          <div class="flex justify-between mb-2">
            <span class="text-sm text-slate-400">Progreso</span>
            <span class="text-sm font-bold gain" id="progress-pct-coinbase">0%</span>
          </div>
          <div class="w-full bg-slate-700 rounded h-3 overflow-hidden">
            <div class="bg-emerald-500 h-3 rounded transition-all duration-500" id="progress-bar-coinbase" style="width: 0%"></div>
          </div>
        </div>
      </div>
      <div class="chart-card lg:col-span-2">
        <h3 class="text-lg font-bold mb-4">üìà Evoluci√≥n de Capital</h3>
        <canvas id="chart-capital-coinbase" height="200"></canvas>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üìä P&L Acumulado (Diario)</h3>
        <canvas id="chart-pl-daily-coinbase" height="250"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üéØ Top S√≠mbolos</h3>
        <canvas id="chart-symbols-coinbase" height="250"></canvas>
      </div>
    </div>

    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">üìã Detalle de Trades</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="border-b border-slate-600">
            <tr class="text-slate-400 text-xs uppercase">
              <th class="text-left py-3 px-4">Fecha</th>
              <th class="text-left py-3 px-4">S√≠mbolo</th>
              <th class="text-left py-3 px-4">Lado</th>
              <th class="text-right py-3 px-4">Cantidad</th>
              <th class="text-right py-3 px-4">Precio</th>
              <th class="text-right py-3 px-4">Total</th>
              <th class="text-right py-3 px-4">Fee</th>
              <th class="text-right py-3 px-4">P&L USD</th>
              <th class="text-right py-3 px-4">P&L %</th>
            </tr>
          </thead>
          <tbody id="tbody-coinbase"></tbody>
        </table>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">ü•á Top Ganadores</h3>
        <div id="winners-list-coinbase" class="space-y-3"></div>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üîª Top Perdedores</h3>
        <div id="losers-list-coinbase" class="space-y-3"></div>
      </div>
    </div>

  </div>

  <!-- TAB ALL (TODOS) -->
  <div id="tab-all" class="tab-content">
    
    <!-- KPIs Row 1 - M√©tricas principales de P&L -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all" onclick="showAllOperations('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Total Ops</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-ops">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-pl-realized" style="color: var(--color-emerald);">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-all-pl-realized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-pl-unrealized">-</p>
        <p class="text-xs text-slate-400 mt-1" id="kpi-all-pl-unrealized-pct-sub">-</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-purple-500 transition-all" onclick="showPositionsSummary('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Posiciones</p>
        <p class="text-2xl font-bold mt-2">
          <span class="gain" id="kpi-all-pos-closed">-</span> / 
          <span class="text-slate-400" id="kpi-all-pos-open">-</span>
        </p>
        <p class="text-xs text-slate-400 mt-1">Cerr / Abier</p>
      </div>
    </div>
    
    <!-- KPIs Row 2 - M√©tricas de rendimiento -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="showClosedOperations('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Realizado %</p>
        <p class="text-3xl font-bold mt-2 gain" id="kpi-all-pl-realized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Cerradas)</p>
      </div>
      <div class="kpi-card text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="showOpenPositions('all')">
        <p class="text-slate-400 text-xs uppercase tracking-widest">P&L Unrealized %</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-pl-unrealized-pct">-</p>
        <p class="text-xs text-slate-400 mt-1">(Abiertas)</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Win Rate</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-wr">-</p>
      </div>
      <div class="kpi-card text-center">
        <p class="text-slate-400 text-xs uppercase tracking-widest">Profit Factor</p>
        <p class="text-3xl font-bold mt-2" id="kpi-all-pf">-</p>
      </div>
    </div>
    
    <!-- Posiciones Abiertas -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">üìä Posiciones Abiertas (Combinado)</h3>
      <div id="open-positions-all" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <!-- Performance por Hora -->
    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">‚è∞ Performance por Hora del D√≠a (Todos los Brokers)</h3>
      <canvas id="chart-hourly-all" height="200"></canvas>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üí∞ Capital Actual</h3>
        <p class="text-4xl font-bold gain mb-2" id="capital-actual-all">$-</p>
        <p class="text-sm text-slate-400 mb-4">Meta EOY 2026: $25,000</p>
        <div class="mt-6 bg-emerald-900/20 rounded p-4">
          <div class="flex justify-between mb-2">
            <span class="text-sm text-slate-400">Progreso</span>
            <span class="text-sm font-bold gain" id="progress-pct-all">0%</span>
          </div>
          <div class="w-full bg-slate-700 rounded h-3 overflow-hidden">
            <div class="bg-emerald-500 h-3 rounded transition-all duration-500" id="progress-bar-all" style="width: 0%"></div>
          </div>
        </div>
      </div>
      <div class="chart-card lg:col-span-2">
        <h3 class="text-lg font-bold mb-4">üìà Evoluci√≥n de Capital (Combinado)</h3>
        <canvas id="chart-capital-all" height="200"></canvas>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üìä P&L Acumulado (Diario)</h3>
        <canvas id="chart-pl-daily-all" height="250"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üéØ Top S√≠mbolos</h3>
        <canvas id="chart-symbols-all" height="250"></canvas>
      </div>
    </div>

    <div class="chart-card mb-8">
      <h3 class="text-lg font-bold mb-4">üìã Detalle de Trades (√∫ltimos 50)</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="border-b border-slate-600">
            <tr class="text-slate-400 text-xs uppercase">
              <th class="text-left py-3 px-4">Broker</th>
              <th class="text-left py-3 px-4">Fecha</th>
              <th class="text-left py-3 px-4">S√≠mbolo</th>
              <th class="text-left py-3 px-4">Lado</th>
              <th class="text-right py-3 px-4">Cantidad</th>
              <th class="text-right py-3 px-4">Precio</th>
              <th class="text-right py-3 px-4">Total</th>
              <th class="text-right py-3 px-4">Fee</th>
              <th class="text-right py-3 px-4">P&L USD</th>
              <th class="text-right py-3 px-4">P&L %</th>
            </tr>
          </thead>
          <tbody id="tbody-all"></tbody>
        </table>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">ü•á Top 10 Ganadores</h3>
        <div id="winners-list-all" class="space-y-3"></div>
      </div>
      <div class="chart-card">
        <h3 class="text-lg font-bold mb-4">üîª Top 10 Perdedores</h3>
        <div id="losers-list-all" class="space-y-3"></div>
      </div>
    </div>

  </div>

</main>

<!-- SCRIPTS -->
<script>
  let chartsMap = {};  // Guardar refs de charts para actualizar
  let schwabData = null;
  let coinbaseData = null;
  let allData = null;
  let currentDays = 30;  // Default 30 d√≠as
  let ws = null;  // WebSocket connection
  let currentBroker = 'schwab';  // Broker activo

  // ========================================================================
  // FORMATEO CENTRALIZADO DE N√öMEROS
  // ========================================================================
  
  /**
   * Formatea un n√∫mero con separador de miles (coma) y decimales (punto)
   * @param {number} value - Valor a formatear
   * @param {number} decimals - N√∫mero de decimales (default: 2)
   * @param {boolean} includeSign - Si incluir signo + para positivos
   * @returns {string} - N√∫mero formateado: "1,234.56" o "+1,234.56"
   */
  function formatNumber(value, decimals = 2, includeSign = false) {
    const sign = includeSign && value >= 0 ? '+' : '';
    return sign + value.toLocaleString('en-US', {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });
  }

  /**
   * Formatea un monto en USD con s√≠mbolo $
   * @param {number} value - Valor a formatear
   * @param {number} decimals - N√∫mero de decimales (default: 2)
   * @param {boolean} includeSign - Si incluir signo + para positivos
   * @returns {string} - "$1,234.56" o "+$1,234.56"
   */
  function formatUSD(value, decimals = 2, includeSign = false) {
    const sign = includeSign && value >= 0 ? '+' : '';
    const absValue = Math.abs(value);
    return sign + '$' + absValue.toLocaleString('en-US', {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });
  }

  /**
   * Formatea un porcentaje con s√≠mbolo %
   * @param {number} value - Valor del porcentaje
   * @param {number} decimals - N√∫mero de decimales (default: 2)
   * @param {boolean} includeSign - Si incluir signo + para positivos
   * @returns {string} - "12.34%" o "+12.34%"
   */
  function formatPercent(value, decimals = 2, includeSign = true) {
    const sign = includeSign && value >= 0 ? '+' : '';
    return sign + value.toFixed(decimals) + '%';
  }

  /**
   * Determina el n√∫mero de decimales correcto para un s√≠mbolo crypto
   * @param {string} symbol - S√≠mbolo del producto (ej: "BTC-USD")
   * @returns {number} - N√∫mero de decimales (2-8)
   */
  function getDecimalsForSymbol(symbol) {
    // Stocks (Schwab): siempre 2 decimales
    if (!symbol.includes('-USD')) {
      return 2;
    }
    
    // Crypto (Coinbase): depende del token
    // Tokens principales: 2 decimales
    if (['BTC-USD', 'ETH-USD', 'SOL-USD', 'BNB-USD'].includes(symbol)) {
      return 2;
    }
    
    // Tokens de precio medio: 4 decimales
    if (['ADA-USD', 'DOT-USD', 'MATIC-USD'].includes(symbol)) {
      return 4;
    }
    
    // Tokens peque√±os: 6-8 decimales
    if (['SHIB-USD', 'PEPE-USD', 'FLOKI-USD'].includes(symbol)) {
      return 8;
    }
    
    // Default: 4 decimales para crypto desconocido
    return 4;
  }

  // ========================================================================
  // WEBSOCKET CONNECTION
  // ========================================================================
  
  function connectWebSocket() {
    const wsUrl = `ws://${window.location.host}/ws/journal`;
    console.log('üîå Conectando a WebSocket:', wsUrl);
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = () => {
      console.log('‚úÖ WebSocket conectado');
      // Solicitar datos iniciales
      requestData();
    };
    
    ws.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data);
        console.log('üì® Mensaje recibido:', message.type);
        
        if (message.data) {
          // Actualizar datos seg√∫n el broker
          const broker = message.broker || 'all';
          
          if (broker === 'all') {
            allData = message.data;
            if (currentBroker === 'all') renderTab('all');
          } else if (broker === 'schwab') {
            schwabData = message.data;
            if (currentBroker === 'schwab') renderTab('schwab');
          } else if (broker === 'coinbase') {
            coinbaseData = message.data;
            if (currentBroker === 'coinbase') renderTab('coinbase');
          }
          
          // Actualizar timestamp
          const now = new Date();
          document.getElementById('last-update').textContent = now.toLocaleTimeString('es-ES');
          
          // Actualizar contador
          updateStatsCounter();
        }
      } catch (error) {
        console.error('‚ùå Error procesando mensaje:', error);
      }
    };
    
    ws.onerror = (error) => {
      console.error('‚ùå WebSocket error:', error);
    };
    
    ws.onclose = () => {
      console.log('üîå WebSocket desconectado, reconectando en 3s...');
      setTimeout(connectWebSocket, 3000);
    };
  }
  
  function requestData() {
    if (ws && ws.readyState === WebSocket.OPEN) {
      // Solicitar los 3 brokers con el per√≠odo actual
      ws.send(JSON.stringify({ broker: 'all', days: currentDays }));
      ws.send(JSON.stringify({ broker: 'schwab', days: currentDays }));
      ws.send(JSON.stringify({ broker: 'coinbase', days: currentDays }));
    }
  }
  
  function updateStatsCounter() {
    const totalTradesSchwab = schwabData?.trades?.length || 0;
    const totalTradesCoinbase = coinbaseData?.trades?.length || 0;
    const totalOps = (schwabData?.stats?.total_ops || 0) + (coinbaseData?.stats?.total_ops || 0);
    const statsText = `${totalOps} operaciones | ${totalTradesSchwab + totalTradesCoinbase} trades | Schwab: ${totalTradesSchwab} | Coinbase: ${totalTradesCoinbase}`;
    document.getElementById('current-period-stats').textContent = statsText;
  }

  // ========================================================================
  // GESTI√ìN DE FILTROS DE FECHA
  // ========================================================================
  
  function changeDays(days) {
    console.log('üîÑ Cambiando per√≠odo a:', days, 'd√≠as');
    currentDays = days;
    
    // Update active button
    document.querySelectorAll('.date-filter-btn').forEach(btn => btn.classList.remove('active'));
    const targetBtn = document.getElementById(`btn-${days}d`);
    if (targetBtn) {
      targetBtn.classList.add('active');
    } else {
      console.error('‚ùå No se encontr√≥ bot√≥n con ID:', `btn-${days}d`);
    }
    
    // Update display text
    const displayTexts = {
      7: '√öltimos 7 d√≠as',
      30: '√öltimos 30 d√≠as',
      90: '√öltimos 90 d√≠as',
      365: '√öltimo a√±o'
    };
    const displayText = displayTexts[days] || `√öltimos ${days} d√≠as`;
    document.getElementById('current-period-display').textContent = displayText;
    console.log('üìÖ Per√≠odo actualizado a:', displayText);
    
    // Destruir TODOS los charts antes de recargar
    Object.keys(chartsMap).forEach(key => {
      if (chartsMap[key]) {
        chartsMap[key].destroy();
        console.log('üóëÔ∏è Chart destruido:', key);
      }
    });
    chartsMap = {};
    
    // Solicitar nuevos datos via WebSocket
    console.log('üìä Solicitando datos via WebSocket con days=', currentDays);
    requestData();
  }
  
  function showCustomDatePicker() {
    // TODO: Implementar modal con date pickers
    alert('üìÜ Custom date picker - Por implementar\n\nPor ahora usa los botones predefinidos: 7d, 30d, 90d, 1 a√±o');
  }

  // ========================================================================
  // CARGAR DATOS (LEGACY - Ahora usamos WebSocket)
  // ========================================================================
  
  // Funci√≥n eliminada - Todo se maneja via WebSocket ahora

  // ========================================================================
  // RENDERIZAR POSICIONES ABIERTAS
  // ========================================================================
  
  function renderOpenPositions(positions, broker) {
    const container = document.getElementById(`open-positions-${broker}`);
    if (!container) return;
    
    if (!positions || positions.length === 0) {
      container.innerHTML = '<div class="col-span-3 text-center text-slate-400 py-4">Sin posiciones abiertas</div>';
      return;
    }
    
    // El backend YA agrupa por s√≠mbolo, solo renderizar con formateo centralizado
    container.innerHTML = positions.map(pos => {
      const pl = pos.unrealized_pl || 0;
      const plPct = pos.unrealized_percent || 0;
      const plClass = pl >= 0 ? 'gain' : 'loss';
      // Determinar decimales: si es crypto (Coinbase), usar getDecimalsForSymbol, si no 2
      const decimals = pos.symbol.includes('-USD') ? getDecimalsForSymbol(pos.symbol) : 2;
      
      return `
        <div class="kpi-card">
          <div class="flex justify-between items-start mb-2">
            <span class="font-bold text-xl text-emerald-400">${pos.symbol}</span>
            <span class="text-xs px-2 py-1 rounded bg-blue-900/30 text-blue-400">
              LONG
            </span>
          </div>
          <div class="text-sm text-slate-400 space-y-1">
            <div class="flex justify-between">
              <span>Cantidad:</span>
              <span class="font-bold text-white">${formatNumber(pos.qty, 4, false)} ${pos.symbol.includes('-USD') ? 'units' : 'shares'}</span>
            </div>
            <div class="flex justify-between">
              <span>Avg Cost:</span>
              <span class="font-bold text-white">${formatUSD(pos.avg_cost, decimals, false)}</span>
            </div>
            <div class="flex justify-between">
              <span>Current:</span>
              <span class="font-bold text-white">${formatUSD(pos.current_price, decimals, false)}</span>
            </div>
            <div class="flex justify-between">
              <span>Cost Basis:</span>
              <span class="font-bold text-white">${formatUSD(pos.cost_basis, 2, false)}</span>
            </div>
            <div class="flex justify-between pt-2 border-t border-slate-600">
              <span>P&L Unrealized:</span>
              <span class="font-bold ${plClass}">${formatUSD(pl, 2, true)} (${formatPercent(plPct, 2, true)})</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ========================================================================
  // RENDERIZAR TAB
  // ========================================================================

  function renderTab(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data || data.error) return;

    const suffix = broker === 'schwab' ? '-schwab' : (broker === 'coinbase' ? '-coinbase' : '-all');

    // KPIs - USAR CAMPOS CORRECTOS DEL API T0
    const stats = data.stats || {};
    const positions = data.positions || {};
    
    // Total Ops = operaciones (no trades individuales)
    document.getElementById(`kpi-${broker}-ops`).textContent = stats.total_ops || 0;
    
    // P&L Realizado vs Unrealized - USAR CAMPOS _usd Y % con formateo centralizado
    const plRealized = stats.pl_realized_usd || 0;
    const plRealizedPct = stats.pl_realized_percent || 0;
    const plUnrealized = stats.pl_unrealized_usd || 0;
    const plUnrealizedPct = stats.pl_unrealized_percent || 0;
    
    // Row 1: P&L USD con formateo (signo + comas separador de miles)
    document.getElementById(`kpi-${broker}-pl-realized`).textContent = formatUSD(plRealized, 2, true);
    document.getElementById(`kpi-${broker}-pl-realized`).className = `text-3xl font-bold mt-2 ${plRealized >= 0 ? 'gain' : 'loss'}`;
    
    // Actualizar el texto de porcentaje de P&L Realizado
    const plRealizedSubtext = document.querySelector(`#kpi-${broker}-pl-realized`).nextElementSibling;
    if (plRealizedSubtext) {
      plRealizedSubtext.textContent = `${formatPercent(plRealizedPct, 2, true)} (Cerradas)`;
    }
    
    document.getElementById(`kpi-${broker}-pl-unrealized`).textContent = formatUSD(plUnrealized, 2, true);
    document.getElementById(`kpi-${broker}-pl-unrealized`).className = `text-3xl font-bold mt-2 ${plUnrealized >= 0 ? 'gain' : (plUnrealized < 0 ? 'loss' : 'text-slate-400')}`;
    
    // Actualizar el texto de porcentaje de P&L Unrealized
    const plUnrealizedSubtext = document.querySelector(`#kpi-${broker}-pl-unrealized`).nextElementSibling;
    if (plUnrealizedSubtext) {
      plUnrealizedSubtext.textContent = `${formatPercent(plUnrealizedPct, 2, true)} (Abiertas)`;
    }
    
    // Actualizar subtextos de porcentaje en Row 1 (debajo de P&L USD)
    const plRealizedPctSub = document.getElementById(`kpi-${broker}-pl-realized-pct-sub`);
    if (plRealizedPctSub) {
      plRealizedPctSub.textContent = `${formatPercent(plRealizedPct, 2, true)} (Cerradas)`;
      plRealizedPctSub.className = `text-xs mt-1 ${plRealizedPct >= 0 ? 'gain' : 'loss'}`;
    }
    
    const plUnrealizedPctSub = document.getElementById(`kpi-${broker}-pl-unrealized-pct-sub`);
    if (plUnrealizedPctSub) {
      plUnrealizedPctSub.textContent = `${formatPercent(plUnrealizedPct, 2, true)} (Abiertas)`;
      plUnrealizedPctSub.className = `text-xs mt-1 ${plUnrealizedPct >= 0 ? 'gain' : 'loss'}`;
    }
    
    // NUEVOS KPIs Row 2: P&L % como tarjetas principales
    const plRealizedPctElement = document.getElementById(`kpi-${broker}-pl-realized-pct`);
    if (plRealizedPctElement) {
      plRealizedPctElement.textContent = formatPercent(plRealizedPct, 2, true);
      plRealizedPctElement.className = `text-3xl font-bold mt-2 ${plRealizedPct >= 0 ? 'gain' : 'loss'}`;
    }
    
    const plUnrealizedPctElement = document.getElementById(`kpi-${broker}-pl-unrealized-pct`);
    if (plUnrealizedPctElement) {
      plUnrealizedPctElement.textContent = formatPercent(plUnrealizedPct, 2, true);
      plUnrealizedPctElement.className = `text-3xl font-bold mt-2 ${plUnrealizedPct >= 0 ? 'gain' : (plUnrealizedPct < 0 ? 'loss' : 'text-slate-400')}`;
    }
    
    document.getElementById(`kpi-${broker}-wr`).textContent = formatPercent(stats.win_rate || 0, 2, false);
    document.getElementById(`kpi-${broker}-pf`).textContent = formatNumber(stats.profit_factor || 0, 2, false);
    
    // Posiciones abiertas/cerradas - USAR positions del API
    const posClosed = positions.closed_count || 0;
    const posOpen = positions.open_count || 0;
    document.getElementById(`kpi-${broker}-pos-closed`).textContent = posClosed;
    document.getElementById(`kpi-${broker}-pos-open`).textContent = posOpen;
    
    // Count total de trades (no ops)
    const tradesCount = data.period?.trades_count || data.trades?.length || 0;
    document.getElementById(`count-${broker}`).textContent = tradesCount;
    
    // Renderizar posiciones abiertas - USAR open_detail
    renderOpenPositions(data.positions?.open_detail || [], broker);

    // Capital - usar formateo centralizado
    const capital = data.capital || {};
    const currentCapital = capital.current || 5000;
    document.getElementById(`capital-actual-${broker}`).textContent = formatUSD(currentCapital, 2, false);
    
    const progressPct = Math.min(((currentCapital) / 25000) * 100, 100);
    document.getElementById(`progress-pct-${broker}`).textContent = `${progressPct.toFixed(1)}%`;
    document.getElementById(`progress-bar-${broker}`).style.width = `${progressPct}%`;

    // Renderizar charts
    renderCapitalChart(data, broker, suffix);
    renderPLDailyChart(data, broker, suffix);
    renderSymbolsChart(data, broker, suffix);
    renderHourlyPerformance(data.trades || [], broker, suffix);

    // Tabla
    const maxTrades = broker === 'all' ? 50 : 30;
    renderTable(data.trades || [], broker, suffix, maxTrades);

    // Winners/Losers
    const topN = broker === 'all' ? 10 : 5;
    renderWinnersLosers(data.trades || [], broker, suffix, topN);
  }

  // ========================================================================
  // CHARTS
  // ========================================================================

  function renderCapitalChart(data, broker, suffix) {
    const evolution = (data.capital?.evolution || []).slice(-30);  // √öltimos 30 d√≠as
    const ctx = document.getElementById(`chart-capital${suffix}`);
    if (!ctx) return;
    
    const chartKey = `capital-${broker}`;
    if (chartsMap[chartKey]) chartsMap[chartKey].destroy();

    chartsMap[chartKey] = new Chart(ctx.getContext('2d'), {
      type: 'line',
      data: {
        labels: evolution.map(d => d.date.slice(5)),
        datasets: [{
          label: 'Capital (USD)',
          data: evolution.map(d => d.capital_end),
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 5,
          pointBackgroundColor: '#10b981',
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (context) => {
                const idx = context[0].dataIndex;
                return evolution[idx].date;
              },
              label: (context) => {
                const value = context.parsed.y;
                const idx = context.dataIndex;
                const plDaily = evolution[idx].pl_daily || 0;
                return [
                  `Capital: $${value.toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                  `P&L del d√≠a: $${plDaily.toFixed(2)}`
                ];
              }
            }
          }
        },
        scales: {
          y: {
            ticks: { 
              color: '#94a3b8',
              callback: (value) => '$' + value.toLocaleString('en-US', {maximumFractionDigits: 0})
            },
            grid: { color: 'rgba(71, 85, 105, 0.1)' },
            beginAtZero: false,
            title: {
              display: true,
              text: 'Capital (USD)',
              color: '#94a3b8'
            }
          },
          x: {
            ticks: { color: '#94a3b8', maxRotation: 45 },
            grid: { display: false },
            title: {
              display: true,
              text: 'Fecha',
              color: '#94a3b8'
            }
          }
        }
      }
    });
  }

  function renderHourlyPerformance(trades, broker, suffix) {
    const ctx = document.getElementById(`chart-hourly${suffix}`);
    if (!ctx) return;
    
    // Agrupar trades por hora (9 AM - 4 PM = market hours)
    const hourlyPL = {};
    for (let hour = 9; hour <= 16; hour++) {
      hourlyPL[hour] = { pl: 0, count: 0 };
    }
    
    trades.forEach(trade => {
      if (!trade.datetime || !trade.pl_realized) return;
      
      const tradeDate = new Date(trade.datetime);
      const hour = tradeDate.getHours();
      
      if (hour >= 9 && hour <= 16) {
        hourlyPL[hour].pl += (trade.pl_realized || 0);
        hourlyPL[hour].count++;
      }
    });
    
    const hours = Object.keys(hourlyPL).sort();
    const plValues = hours.map(h => hourlyPL[h].pl);
    const counts = hours.map(h => hourlyPL[h].count);
    
    const chartKey = `hourly-${broker}`;
    if (chartsMap[chartKey]) chartsMap[chartKey].destroy();
    
    chartsMap[chartKey] = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: hours.map(h => `${h}:00`),
        datasets: [{
          label: 'P&L por Hora',
          data: plValues,
          backgroundColor: plValues.map(v => v >= 0 ? '#10b981' : '#ef4444'),
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => {
                const idx = context.dataIndex;
                const pl = plValues[idx];
                const count = counts[idx];
                return `P&L: $${pl.toFixed(2)} (${count} trades)`;
              }
            }
          }
        },
        scales: {
          y: {
            ticks: { 
              color: '#94a3b8',
              callback: (value) => '$' + value.toFixed(0)
            },
            grid: { color: 'rgba(71, 85, 105, 0.1)' }
          },
          x: {
            ticks: { color: '#94a3b8' },
            grid: { display: false }
          }
        }
      }
    });
  }

  function renderPLDailyChart(data, broker, suffix) {
    const evolution = (data.capital?.evolution || []).slice(-20);
    const ctx = document.getElementById(`chart-pl-daily${suffix}`);
    if (!ctx) return;
    
    const chartKey = `pl-daily-${broker}`;
    if (chartsMap[chartKey]) chartsMap[chartKey].destroy();

    chartsMap[chartKey] = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: evolution.map(d => d.date.slice(5)),
        datasets: [{
          label: 'P&L Diario (USD)',
          data: evolution.map(d => d.pl_daily),
          backgroundColor: evolution.map(d => d.pl_daily >= 0 ? '#10b981' : '#ef4444'),
          borderRadius: 6,
          borderSkipped: false
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: { 
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (context) => {
                const idx = context[0].dataIndex;
                return evolution[idx].date;
              },
              label: (context) => {
                const value = context.parsed.x;
                return `P&L del d√≠a: $${value.toFixed(2)}`;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { 
              color: '#94a3b8',
              callback: (value) => '$' + value.toFixed(0)
            },
            grid: { color: 'rgba(71, 85, 105, 0.1)' },
            title: {
              display: true,
              text: 'P&L (USD)',
              color: '#94a3b8'
            }
          },
          y: {
            ticks: { color: '#94a3b8', font: { size: 11 } },
            grid: { display: false },
            title: {
              display: true,
              text: 'Fecha',
              color: '#94a3b8'
            }
          }
        }
      }
    });
  }

  function renderSymbolsChart(data, broker, suffix) {
    const symbols = (data.symbols || {});
    const top5 = Object.entries(symbols)
      .sort((a, b) => Math.abs(b[1].pl_usd) - Math.abs(a[1].pl_usd))
      .slice(0, 5);

    const ctx = document.getElementById(`chart-symbols${suffix}`);
    if (!ctx) return;
    
    const chartKey = `symbols-${broker}`;
    if (chartsMap[chartKey]) chartsMap[chartKey].destroy();

    chartsMap[chartKey] = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: top5.map(s => s[0]),
        datasets: [{
          label: 'P&L USD',
          data: top5.map(s => s[1].pl_usd),
          backgroundColor: top5.map(s => s[1].pl_usd >= 0 ? '#10b981' : '#ef4444'),
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'x',
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            ticks: { color: '#94a3b8' },
            grid: { color: 'rgba(71, 85, 105, 0.1)' }
          },
          x: {
            ticks: { color: '#94a3b8' },
            grid: { display: false }
          }
        }
      }
    });
  }

  // ========================================================================
  // TABLA DE TRADES
  // ========================================================================

  function renderTable(trades, broker, suffix, maxTrades = 30) {
    const tbody = document.getElementById(`tbody${suffix}`);
    if (!tbody) return;
    
    const lastTrades = trades.slice(-maxTrades).reverse();  // √öltimos N, m√°s recientes primero

    tbody.innerHTML = lastTrades.map(t => {
      const plUsd = (t.pl_usd || 0);
      const plPercent = (t.pl_percent || 0);
      const isWinner = plUsd > 0;
      
      const dateStr = new Date(t.datetime).toLocaleDateString('es-ES', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const brokerBadge = broker === 'all' ? `<td class="py-3 px-4"><span class="text-xs px-2 py-1 rounded ${t.broker === 'schwab' ? 'bg-blue-900 text-blue-300' : 'bg-orange-900 text-orange-300'}">${t.broker?.toUpperCase()}</span></td>` : '';
      
      return `
        <tr class="table-row">
          ${brokerBadge}
          <td class="py-3 px-4 text-slate-300">${dateStr}</td>
          <td class="py-3 px-4 font-bold text-emerald-400">${t.symbol}</td>
          <td class="py-3 px-4">${t.side === 'BUY' ? 'üìà' : 'üìâ'} ${t.side}</td>
          <td class="py-3 px-4 text-right">${parseFloat(t.quantity).toFixed(t.broker === 'coinbase' ? 8 : 2)}</td>
          <td class="py-3 px-4 text-right">$${parseFloat(t.price).toFixed(2)}</td>
          <td class="py-3 px-4 text-right">$${parseFloat(t.total || t.amount || 0).toFixed(2)}</td>
          <td class="py-3 px-4 text-right">$${parseFloat(t.fee).toFixed(2)}</td>
          <td class="py-3 px-4 text-right ${isWinner ? 'gain' : 'loss'}">${isWinner ? '+' : ''}$${Math.abs(plUsd).toFixed(2)}</td>
          <td class="py-3 px-4 text-right ${isWinner ? 'gain' : 'loss'}">${isWinner ? '+' : ''}${Math.abs(plPercent).toFixed(2)}%</td>
        </tr>
      `;
    }).join('');
  }

  // ========================================================================
  // WINNERS/LOSERS
  // ========================================================================

  function renderWinnersLosers(trades, broker, suffix, topN = 5) {
    const symbolPL = {};
    
    trades.forEach(t => {
      if (!symbolPL[t.symbol]) {
        symbolPL[t.symbol] = { pl_usd: 0, pl_percent: 0, cost_basis: 0, trades: 0 };
      }
      symbolPL[t.symbol].pl_usd += (t.pl_usd || 0);
      
      // Calcular P&L % acumulado: necesitamos sumar cost_basis y P&L USD
      const tradeCost = Math.abs(t.price * t.quantity);
      symbolPL[t.symbol].cost_basis += tradeCost;
      symbolPL[t.symbol].trades += 1;
    });

    // Calcular P&L % total para cada s√≠mbolo
    Object.values(symbolPL).forEach(stats => {
      if (stats.cost_basis > 0) {
        stats.pl_percent = (stats.pl_usd / stats.cost_basis) * 100;
      }
    });

    const sorted = Object.entries(symbolPL)
      .map(([sym, stats]) => ({ symbol: sym, ...stats }))
      .sort((a, b) => b.pl_usd - a.pl_usd);

    const winners = sorted.slice(0, topN);
    const losers = sorted.slice(-topN).reverse();

    const winnersEl = document.getElementById(`winners-list${suffix}`);
    const losersEl = document.getElementById(`losers-list${suffix}`);
    
    if (winnersEl) {
      winnersEl.innerHTML = winners.map(w => `
        <div class="bg-slate-700/30 p-3 rounded flex justify-between hover:bg-slate-700/50 transition">
          <div>
            <span class="font-bold">${w.symbol}</span>
            <p class="text-xs text-slate-400">${w.trades} ops</p>
          </div>
          <div class="text-right">
            <span class="gain text-lg">+$${Math.abs(w.pl_usd).toFixed(2)}</span>
            <p class="text-xs gain">+${w.pl_percent.toFixed(2)}%</p>
          </div>
        </div>
      `).join('');
    }

    if (losersEl) {
      losersEl.innerHTML = losers.map(l => `
        <div class="bg-slate-700/30 p-3 rounded flex justify-between hover:bg-slate-700/50 transition">
          <div>
            <span class="font-bold">${l.symbol}</span>
            <p class="text-xs text-slate-400">${l.trades} ops</p>
          </div>
          <div class="text-right">
            <span class="loss text-lg">-$${Math.abs(l.pl_usd).toFixed(2)}</span>
            <p class="text-xs loss">${l.pl_percent.toFixed(2)}%</p>
          </div>
        </div>
      `).join('');
    }
  }

  // ========================================================================
  // CONTROLS
  // ========================================================================

  function switchTab(tab) {
    // Remover active de todos
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    // Activar el seleccionado
    document.getElementById(`tab-btn-${tab}`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
  }

  function refreshData() {
    requestData();  // Usar WebSocket
  }

  // ========================================================================
  // AG-GRID MODAL FUNCTIONS
  // ========================================================================
  
  let gridApi = null;

  function showAgGridModal(rowData, columnDefs, title) {
    const modal = document.getElementById('ag-grid-modal');
    const modalTitle = document.getElementById('modal-title');
    const container = document.getElementById('ag-grid-container');
    
    // Configurar t√≠tulo
    modalTitle.textContent = title;
    
    // Limpiar grid anterior
    container.innerHTML = '';
    
    // Configuraci√≥n de Ag-Grid
    const gridOptions = {
      columnDefs: columnDefs,
      rowData: rowData,
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        flex: 1,
        minWidth: 100
      },
      pagination: true,
      paginationPageSize: 20,
      enableCellTextSelection: true,
      ensureDomOrder: true,
      animateRows: true,
      domLayout: 'normal'
    };
    
    // Crear grid
    gridApi = agGrid.createGrid(container, gridOptions);
    
    // Mostrar modal
    modal.classList.add('active');
  }

  function closeAgGridModal() {
    const modal = document.getElementById('ag-grid-modal');
    modal.classList.remove('active');
    if (gridApi) {
      gridApi.destroy();
      gridApi = null;
    }
    // Destruir grids del modal de posiciones si existen
    if (window.closedGridApi) {
      window.closedGridApi.destroy();
      window.closedGridApi = null;
    }
    if (window.openGridApi) {
      window.openGridApi.destroy();
      window.openGridApi = null;
    }
  }

  // ========================================================================
  // CLICK HANDLERS - OPERACIONES CERRADAS
  // ========================================================================

  function showClosedOperations(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data || !data.trades) return;

    // Filtrar operaciones cerradas (pl_usd !== 0)
    const closedTrades = data.trades.filter(t => t.pl_usd && t.pl_usd !== 0);

    const columnDefs = [
      { field: 'datetime', headerName: 'Fecha', valueFormatter: p => new Date(p.value).toLocaleString('es-ES') },
      { field: 'symbol', headerName: 'S√≠mbolo' },
      { field: 'side', headerName: 'Lado' },
      { field: 'quantity', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'price', 
        headerName: 'Precio', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(parseFloat(p.value), decimals, false);
        }
      },
      { field: 'fee', headerName: 'Fee', type: 'numericColumn', valueFormatter: p => formatUSD(parseFloat(p.value), 2, false) },
      { 
        field: 'pl_usd', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => formatUSD(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { 
        field: 'pl_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => formatPercent(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      }
    ];

    const brokerName = broker === 'schwab' ? 'Schwab' : (broker === 'coinbase' ? 'Coinbase' : 'Todos los Brokers');
    showAgGridModal(closedTrades, columnDefs, `üìä Operaciones Cerradas - ${brokerName} (${closedTrades.length} ops)`);
  }

  // ========================================================================
  // CLICK HANDLERS - TODAS LAS OPERACIONES
  // ========================================================================

  function showAllOperations(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data || !data.trades) return;

    const columnDefs = [
      { field: 'datetime', headerName: 'Fecha', valueFormatter: p => new Date(p.value).toLocaleString('es-ES') },
      { field: 'symbol', headerName: 'S√≠mbolo' },
      { field: 'side', headerName: 'Lado' },
      { field: 'quantity', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'price', 
        headerName: 'Precio', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(parseFloat(p.value), decimals, false);
        }
      },
      { field: 'fee', headerName: 'Fee', type: 'numericColumn', valueFormatter: p => formatUSD(parseFloat(p.value), 2, false) },
      { 
        field: 'pl_usd', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => p.value === 0 ? 'Abierta' : formatUSD(p.value, 2, true),
        cellStyle: p => {
          if (p.value === 0) return { color: '#94a3b8' };
          return { color: p.value >= 0 ? '#10b981' : '#ef4444' };
        }
      },
      { 
        field: 'pl_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => p.value === 0 ? '-' : formatPercent(p.value, 2, true),
        cellStyle: p => {
          if (p.value === 0) return { color: '#94a3b8' };
          return { color: p.value >= 0 ? '#10b981' : '#ef4444' };
        }
      }
    ];

    const brokerName = broker === 'schwab' ? 'Schwab' : (broker === 'coinbase' ? 'Coinbase' : 'Todos los Brokers');
    showAgGridModal(data.trades, columnDefs, `üìã Todas las Operaciones - ${brokerName} (${data.trades.length} trades)`);
  }

  // ========================================================================
  // CLICK HANDLER - RESUMEN DE POSICIONES (CERRADAS + ABIERTAS CON TABS)
  // ========================================================================

  function showPositionsSummary(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data) return;

    const closedTrades = data.trades ? data.trades.filter(t => t.pl_usd && t.pl_usd !== 0) : [];
    const openPos = data.positions?.open_detail || [];
    
    const brokerName = broker === 'schwab' ? 'Schwab' : (broker === 'coinbase' ? 'Coinbase' : 'Todos los Brokers');
    
    // Crear modal personalizado con tabs
    const modal = document.getElementById('ag-grid-modal');
    const modalTitle = document.getElementById('modal-title');
    const container = document.getElementById('ag-grid-container');
    
    modalTitle.textContent = `üìä Resumen de Posiciones - ${brokerName}`;
    
    // HTML personalizado con tabs
    container.innerHTML = `
      <div style="height: 100%; display: flex; flex-direction: column;">
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #475569; padding-bottom: 10px;">
          <button id="tab-closed-btn" onclick="switchPositionsTab('closed')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s;">
            ‚úÖ Cerradas (${closedTrades.length})
          </button>
          <button id="tab-open-btn" onclick="switchPositionsTab('open')" style="padding: 10px 20px; background: #334155; color: #94a3b8; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s;">
            üìà Abiertas (${openPos.length})
          </button>
        </div>
        <div id="positions-grid-closed" class="ag-theme-alpine-dark" style="flex: 1; display: block;"></div>
        <div id="positions-grid-open" class="ag-theme-alpine-dark" style="flex: 1; display: none;"></div>
      </div>
    `;
    
    // Configurar grid de cerradas con formateo centralizado
    const closedColumnDefs = [
      { field: 'datetime', headerName: 'Fecha', valueFormatter: p => new Date(p.value).toLocaleString('es-ES') },
      { field: 'symbol', headerName: 'S√≠mbolo' },
      { field: 'side', headerName: 'Lado' },
      { field: 'quantity', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'price', 
        headerName: 'Precio', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(parseFloat(p.value), decimals, false);
        }
      },
      { field: 'fee', headerName: 'Fee', type: 'numericColumn', valueFormatter: p => formatUSD(parseFloat(p.value), 2, false) },
      { 
        field: 'pl_usd', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => formatUSD(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { 
        field: 'pl_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => formatPercent(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      }
    ];
    
    const closedGridOptions = {
      columnDefs: closedColumnDefs,
      rowData: closedTrades,
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        flex: 1,
        minWidth: 100
      },
      pagination: true,
      paginationPageSize: 20,
      enableCellTextSelection: true,
      ensureDomOrder: true,
      animateRows: true,
      domLayout: 'normal'
    };
    
    // Configurar grid de abiertas con formateo centralizado
    const openColumnDefs = [
      { field: 'symbol', headerName: 'S√≠mbolo' },
      { field: 'qty', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'avg_cost', 
        headerName: 'Costo Prom.', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(p.value, decimals, false);
        }
      },
      { 
        field: 'current_price', 
        headerName: 'Precio Actual', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(p.value, decimals, false);
        }
      },
      { field: 'cost_basis', headerName: 'Base de Costo', type: 'numericColumn', valueFormatter: p => formatUSD(p.value, 2, false) },
      { field: 'current_value', headerName: 'Valor Actual', type: 'numericColumn', valueFormatter: p => formatUSD(p.value, 2, false) },
      { 
        field: 'unrealized_pl', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => formatUSD(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { 
        field: 'unrealized_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => formatPercent(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { field: 'entries', headerName: 'Entradas', type: 'numericColumn' }
    ];
    
    const openGridOptions = {
      columnDefs: openColumnDefs,
      rowData: openPos,
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        flex: 1,
        minWidth: 100
      },
      pagination: true,
      paginationPageSize: 20,
      enableCellTextSelection: true,
      ensureDomOrder: true,
      animateRows: true,
      domLayout: 'normal'
    };
    
    // Crear ambos grids
    window.closedGridApi = agGrid.createGrid(document.getElementById('positions-grid-closed'), closedGridOptions);
    window.openGridApi = agGrid.createGrid(document.getElementById('positions-grid-open'), openGridOptions);
    
    // Mostrar modal
    modal.classList.add('active');
  }

  // Funci√≥n para cambiar entre tabs del modal de posiciones
  window.switchPositionsTab = function(tab) {
    const closedBtn = document.getElementById('tab-closed-btn');
    const openBtn = document.getElementById('tab-open-btn');
    const closedGrid = document.getElementById('positions-grid-closed');
    const openGrid = document.getElementById('positions-grid-open');
    
    if (tab === 'closed') {
      closedBtn.style.background = '#10b981';
      closedBtn.style.color = 'white';
      openBtn.style.background = '#334155';
      openBtn.style.color = '#94a3b8';
      closedGrid.style.display = 'block';
      openGrid.style.display = 'none';
    } else {
      closedBtn.style.background = '#334155';
      closedBtn.style.color = '#94a3b8';
      openBtn.style.background = '#f59e0b';
      openBtn.style.color = 'white';
      closedGrid.style.display = 'none';
      openGrid.style.display = 'block';
    }
  };

  // ========================================================================
  // CLICK HANDLERS - POSICIONES ABIERTAS
  // ========================================================================

  function showOpenPositions(broker) {
    const data = broker === 'schwab' ? schwabData : (broker === 'coinbase' ? coinbaseData : allData);
    if (!data || !data.positions || !data.positions.open_detail) return;

    const openPos = data.positions.open_detail;

    const columnDefs = [
      { field: 'symbol', headerName: 'S√≠mbolo' },
      { field: 'qty', headerName: 'Cantidad', type: 'numericColumn', valueFormatter: p => formatNumber(parseFloat(p.value), 4, false) },
      { 
        field: 'avg_cost', 
        headerName: 'Costo Prom.', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(p.value, decimals, false);
        }
      },
      { 
        field: 'current_price', 
        headerName: 'Precio Actual', 
        type: 'numericColumn', 
        valueFormatter: p => {
          const symbol = p.data.symbol || '';
          const decimals = symbol.includes('-USD') ? getDecimalsForSymbol(symbol) : 2;
          return formatUSD(p.value, decimals, false);
        }
      },
      { field: 'cost_basis', headerName: 'Base de Costo', type: 'numericColumn', valueFormatter: p => formatUSD(p.value, 2, false) },
      { field: 'current_value', headerName: 'Valor Actual', type: 'numericColumn', valueFormatter: p => formatUSD(p.value, 2, false) },
      { 
        field: 'unrealized_pl', 
        headerName: 'P&L USD', 
        type: 'numericColumn',
        valueFormatter: p => formatUSD(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { 
        field: 'unrealized_percent', 
        headerName: 'P&L %', 
        type: 'numericColumn',
        valueFormatter: p => formatPercent(p.value, 2, true),
        cellStyle: p => ({ color: p.value >= 0 ? '#10b981' : '#ef4444' })
      },
      { field: 'entries', headerName: 'Entradas', type: 'numericColumn' }
    ];

    const brokerName = broker === 'schwab' ? 'Schwab' : (broker === 'coinbase' ? 'Coinbase' : 'Todos los Brokers');
    showAgGridModal(openPos, columnDefs, `üìà Posiciones Abiertas - ${brokerName} (${openPos.length} posiciones)`);
  }

  // INIT - Conectar WebSocket al cargar p√°gina
  window.addEventListener('load', () => {
    console.log('üöÄ Iniciando TradePlus Journal con WebSocket');
    connectWebSocket();
    
    // Configurar event listeners del modal (despu√©s de que el DOM est√© listo)
    // Cerrar con ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAgGridModal();
    });

    // Cerrar al hacer click fuera
    const modal = document.getElementById('ag-grid-modal');
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target.id === 'ag-grid-modal') closeAgGridModal();
      });
    }
  });
</script>

<!-- Modal Ag-Grid -->
<div id="ag-grid-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title" class="text-2xl font-bold"></h2>
      <button class="modal-close-btn" onclick="closeAgGridModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="ag-grid-container" class="ag-theme-alpine-dark" style="height: 100%; width: 100%;"></div>
    </div>
  </div>
</div>

</body>
</html>
